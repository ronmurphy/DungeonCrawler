<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Teller Tool - Unified Interface</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rpg-awesome/0.2.0/css/rpg-awesome.min.css">

    <!-- ported StoryTeller.mobile.old css goes here -->
    <link rel="stylesheet" href="css/npc-enhanced.css">
    <link rel="stylesheet" href="css/notes-panel.css">
    <link rel="stylesheet" href="css/maps-panel.css">
    <link rel="stylesheet" href="css/dice-panel.css">
    <link rel="stylesheet" href="css/enhanced_chat_effects.css">
    <link rel="stylesheet" href="css/map.css">
    <link rel="stylesheet" href="css/combat.css">
    <link rel="stylesheet" href="css/initiative-tracker.css">
    <link rel="stylesheet" href="css/storyTellerPlayersPanel.css">
    <link rel="stylesheet" href="css/character-modal.css">
    <link rel="stylesheet" href="css/player-chips-fixed.css">
    <link rel="stylesheet" href="css/player-chips-selection.css">
    <!-- end ported css -->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Device Detection and Resolution Variables */
        :root {
            /* Base values - will be overridden by device detection */
            --base-font-size: 16px;
            --touch-target-min: 44px;
            --panel-gap: 2px;
            /* --padding-base: 20px; */
            --padding-base: 10px;
            --border-radius: 6px;
            --header-height: 60px;
            --tab-height: 50px;
            
            /* Color scheme */
            --primary-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --panel-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            --danger-gradient: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            --warning-gradient: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            --action-gradient: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            
            /* Theme colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e9ecef;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --header-bg: rgba(0, 0, 0, 0.2);
        }

        /* Dark Theme */
        .dark-theme {
            --primary-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            --panel-gradient: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #eee6ff;
            --text-secondary: #a8a8b3;
            --border-color: #16213e;
            --panel-bg: rgba(22, 33, 62, 0.95);
            --header-bg: rgba(0, 0, 0, 0.5);
        }

        .dark-theme body {
            color: var(--text-primary);
            background: var(--primary-gradient);
        }

        .dark-theme .panel {
            background: var(--panel-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .chat-messages {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .chat-message {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .dark-theme .chat-message.system {
            background: rgba(33, 150, 243, 0.2);
            border-left-color: #2196f3;
            color: var(--text-primary);
        }

        .dark-theme .chat-message.player {
            background: rgba(156, 39, 176, 0.2);
            border-left-color: #9c27b0;
            color: var(--text-primary);
        }

        .dark-theme .chat-message.storyteller {
            background: rgba(255, 152, 0, 0.2);
            border-left-color: #ff9800;
            color: var(--text-primary);
        }

        .dark-theme .player-selector {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .player-selector h4 {
            color: var(--text-primary);
        }

        .dark-theme .player-item {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .player-item:hover {
            border-color: #74b9ff;
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.3);
        }

        .dark-theme .player-item.selected {
            border-color: #0984e3;
            background: rgba(227, 242, 253, 0.1);
            box-shadow: 0 2px 12px rgba(9, 132, 227, 0.4);
        }

        .dark-theme .player-name {
            color: var(--text-primary);
        }

        .dark-theme .player-stats {
            color: var(--text-secondary);
        }

        .dark-theme .command-category {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .dark-theme .selected-player-display {
            background: rgba(var(--primary-rgb), 0.1);
        }

        .dark-theme .selected-player-name {
            color: var(--accent-color);
        }

        .dark-theme .selected-player-name.no-selection {
            color: var(--text-secondary);
        }

        .dark-theme .chat-input {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .dark-theme .chat-error {
            background: rgba(255, 235, 238, 0.1);
            border-color: rgba(229, 115, 115, 0.3);
            color: #ff8a80;
        }

        .dark-theme .panel-content {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .dark-theme input, 
        .dark-theme textarea, 
        .dark-theme select {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme input::placeholder,
        .dark-theme textarea::placeholder {
            color: var(--text-secondary);
        }

        .dark-theme .header-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .dark-theme .quick-connect-btn {
            background: var(--action-gradient);
            color: white;
        }

        .dark-theme .quick-connect-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        .dark-theme .panel-btn,
        .dark-theme .command-btn {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .panel-btn:hover,
        .dark-theme .command-btn:hover {
            background: var(--bg-secondary);
            border-color: #74b9ff;
        }

        .dark-theme .send-btn {
            background: var(--action-gradient);
            color: white;
        }

        .dark-theme .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        .dark-theme .close-btn {
            background: var(--danger-gradient);
            color: white;
        }

        .dark-theme .chat-input-area {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .dark-theme .chat-input {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .chat-input:focus {
            border-color: #74b9ff;
        }

        .dark-theme .command-grid {
            background: var(--bg-secondary);
        }

        .dark-theme .command-btn {
            background: var(--action-gradient);
            color: white;
            border-color: var(--border-color);
        }

        .dark-theme .command-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        .dark-theme .command-btn.danger {
            background: var(--danger-gradient);
        }

        .dark-theme .command-btn.success {
            background: var(--success-gradient);
        }

        .dark-theme .command-btn.warning {
            background: var(--warning-gradient);
        }

        .dark-theme .command-btn.storage {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .dark-theme .command-btn.storage:hover {
            background: linear-gradient(135deg, #5dade2, #3498db);
        }

        .dark-theme .command-btn.primary {
            background: var(--primary-gradient);
            color: white;
        }

        .dark-theme .command-note {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .dark-theme .tab-bar {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .dark-theme .tab-selector {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .dark-theme .tab-selector:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .dark-theme .tab-selector.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: #74b9ff;
        }

        .dark-theme .settings-modal-content {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .settings-header {
            background: var(--panel-gradient);
            color: white;
        }

        .dark-theme .settings-section {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .dark-theme .chevron-section {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .dark-theme .chevron-header {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .dark-theme .chevron-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .dark-theme .chevron-content {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Tablet Mode (Default) */
        .mode-tablet {
            --base-font-size: 16px;
            --touch-target-min: 44px;
            --panel-gap: 2px;
            /* --padding-base: 20px; */
            --padding-base: 10px;
            --border-radius: 6px;
            --header-height: 60px;
            --tab-height: 50px;
            --button-padding: 10px 12px;
            --input-height: 44px;
            --grid-gap: 10px;
        }

        /* High Resolution Mode */
        .mode-highres {
            --base-font-size: 18px;
            --touch-target-min: 48px;
            --panel-gap: 3px;
            --padding-base: 25px;
            --border-radius: 8px;
            --header-height: 70px;
            --tab-height: 55px;
            --button-padding: 12px 16px;
            --input-height: 52px;
            --grid-gap: 15px;
        }

        /* Ultra Mode (Premium) */
        .mode-ultra {
            --base-font-size: 20px;
            --touch-target-min: 60px;
            --panel-gap: 4px;
            --padding-base: 30px;
            --border-radius: 12px;
            --header-height: 80px;
            --tab-height: 60px;
            --button-padding: 15px 20px;
            --input-height: 60px;
            --grid-gap: 20px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            font-size: var(--base-font-size);
            background: var(--primary-gradient);
            height: 100vh;
            overflow: hidden;
            color: #333;
            transition: all 0.3s ease;
        }

        /* Mode Toggle Control */
        .mode-toggle {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .mode-toggle.collapsed {
            width: 50px;
            height: 50px;
        }

        .mode-toggle.collapsed .mode-toggle-content {
            display: none;
        }

        .mode-toggle-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            cursor: pointer;
            min-height: 50px;
        }

        .mode-toggle.collapsed .mode-toggle-header {
            justify-content: center;
            padding: 15px;
        }

        .mode-toggle-content {
            padding: 0 15px 15px 15px;
        }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .mode-toggle.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .mode-toggle label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .mode-selector {
            display: flex;
            gap: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 3px;
        }

        .mode-option {
            padding: 6px 10px;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            text-align: center;
            min-width: 55px;
        }

        .mode-option.active {
            background: var(--action-gradient);
            color: white;
            font-weight: 600;
        }

        .mode-option:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .device-info {
            margin-top: 8px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        /* Layout Container */
        .desktop-container {
            display: grid;
            grid-template-rows: var(--header-height) var(--tab-height) 1fr;
            height: 100vh;
            transition: all 0.3s ease;
        }

        /* Header */
        .app-header {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--padding-base);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: calc(var(--padding-base) * 0.5);
            font-size: calc(var(--base-font-size) * 1.4);
            font-weight: 600;
        }

        .app-title i {
            font-size: calc(var(--base-font-size) * 1.6);
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: calc(var(--padding-base) * 0.8);
            font-size: calc(var(--base-font-size) * 0.9);
        }

        .header-controls {
            display: flex;
            gap: calc(var(--padding-base) * 0.5);
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: var(--button-padding);
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
            font-size: calc(var(--base-font-size) * 0.9);
            min-height: var(--touch-target-min);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .header-btn i {
            font-size: calc(var(--base-font-size) * 1.1);
        }

        /* Tab Bar */
        .tab-bar {
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 0 var(--padding-base);
            gap: var(--grid-gap);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: var(--button-padding);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.9);
            transition: all 0.2s;
            min-height: var(--touch-target-min);
        }

        .tab-selector:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab-selector.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .quick-connect-section {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: var(--grid-gap);
        }

        .quick-connect-btn {
            background: var(--success-gradient) !important;
            font-weight: 600;
            min-width: var(--touch-target-min);
            justify-content: center;
        }

        .quick-connect-btn:hover {
            background: linear-gradient(135deg, #00a085 0%, #00b894 100%) !important;
            transform: translateY(-1px);
        }

        .quick-connect-btn.connecting {
            background: var(--warning-gradient) !important;
            cursor: not-allowed;
        }

        .quick-connect-btn.connected {
            background: var(--action-gradient) !important;
        }

        .tab-selector i {
            font-size: calc(var(--base-font-size) * 1.1);
        }

        /* Main Content Area */
        .content-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--panel-gap);
            background: rgba(0, 0, 0, 0.1);
            height: 100%;
        }

        .panel {
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: var(--panel-gradient);
            color: white;
            padding: var(--padding-base);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: calc(var(--touch-target-min) + 20px);
        }

        .panel-title {
            font-weight: 600;
            font-size: calc(var(--base-font-size) * 1.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            font-size: calc(var(--base-font-size) * 1.3);
        }

        .panel-controls {
            display: flex;
            gap: 8px;
        }

        .panel-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: calc(var(--border-radius) * 0.7);
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.85);
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
            min-height: calc(var(--touch-target-min) * 0.8);
            min-width: calc(var(--touch-target-min) * 0.8);
        }

        .panel-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .panel-btn i {
            font-size: calc(var(--base-font-size) * 1);
        }

        .panel-content {
            flex: 1;
            padding: var(--padding-base);
            overflow-y: auto;
        }

        /* Command Interface */
        .command-interface {
            display: grid;
            grid-template-columns: 1fr calc(var(--padding-base) * 12);
            gap: var(--padding-base);
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f1f5f9;
            -webkit-overflow-scrolling: touch;
        }

        /* Admin Interface - Similar to Command Interface but simpler */
        .admin-interface {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f1f5f9;
            -webkit-overflow-scrolling: touch;
        }

        .admin-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(calc(var(--padding-base) * 15), 1fr));
            gap: var(--grid-gap);
            grid-auto-rows: max-content;
        }

        .command-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(calc(var(--padding-base) * 12), 1fr));
            gap: var(--grid-gap);
            grid-auto-rows: max-content;
        }

        .command-category {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .category-header {
            background: var(--panel-gradient);
            color: white;
            padding: calc(var(--padding-base) * 0.7);
            font-weight: 600;
            font-size: calc(var(--base-font-size) * 1.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-header i {
            font-size: calc(var(--base-font-size) * 1.2);
        }

        .category-content {
            padding: var(--grid-gap);
        }

        .command-grid {
            display: grid;
            gap: calc(var(--grid-gap) * 0.7);
            grid-template-columns: repeat(auto-fit, minmax(calc(var(--touch-target-min) * 2.5), 1fr));
        }

        .command-btn {
            background: var(--action-gradient);
            border: none;
            color: white;
            padding: var(--button-padding);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.9);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: var(--touch-target-min);
            text-align: center;
        }

        .command-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        .command-btn:active {
            transform: translateY(0);
        }

        .command-btn.danger {
            background: var(--danger-gradient);
        }

        .command-btn.success {
            background: var(--success-gradient);
        }

        .command-btn.warning {
            background: var(--warning-gradient);
        }

        .command-note {
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(var(--warning-rgb), 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--warning-color);
        }

        .command-note small {
            color: #6c757d;
            font-size: 0.8em;
        }

        /* Selected Player Display (inside command-category) */
        .selected-player-display {
            padding: 8px;
            background: rgba(var(--primary-rgb), 0.05);
            border-radius: 4px;
            margin-bottom: 8px;
            text-align: center;
        }

        .selected-player-name {
            font-weight: 600;
            color: var(--primary-color);
            font-size: calc(var(--base-font-size) * 1.05);
        }

        .selected-player-name.no-selection {
            color: #6c757d;
            font-style: italic;
            font-weight: normal;
        }

        .selection-hint {
            text-align: center;
        }

        .selection-hint small {
            color: #6c757d;
            font-size: 0.8em;
        }

        /* Player Selection */
        .player-selector {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
            padding: var(--padding-base);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Compact player selector for chat panel */
        .chat-interface .player-selector {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            margin: 0;
            border-radius: 0;
            border-left: none;
            border-right: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-interface .player-selector h4 {
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-secondary);
            text-align: center;
        }

        .chat-interface .player-list {
            gap: 4px;
        }

        .chat-interface .player-item {
            padding: 6px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-interface .player-name {
            font-size: 0.85em;
        }

        .chat-interface .player-stats {
            font-size: 0.75em;
            opacity: 0.8;
        }

        .player-selector h4 {
            margin-bottom: var(--grid-gap);
            color: #495057;
            font-size: calc(var(--base-font-size) * 1.1);
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: var(--grid-gap);
        }

        .player-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: calc(var(--padding-base) * 0.7);
            cursor: pointer;
            transition: all 0.2s;
            font-size: calc(var(--base-font-size) * 0.9);
            min-height: var(--touch-target-min);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Override for character items - use horizontal layout */
        .player-item.character-item {
            flex-direction: row !important;
            align-items: center !important;
            justify-content: flex-start !important;
            min-height: auto !important;
        }

        .player-item:hover {
            border-color: #74b9ff;
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.2);
        }

        .player-item.selected {
            border-color: #0984e3;
            background: #e3f2fd;
            box-shadow: 0 2px 12px rgba(9, 132, 227, 0.3);
        }

        .player-name {
            font-weight: 600;
            color: #2d3436;
            font-size: calc(var(--base-font-size) * 1);
        }

        .player-stats {
            font-size: calc(var(--base-font-size) * 0.8);
            color: #636e72;
            margin-top: 4px;
        }

        /* Chat Interface */
        .chat-interface {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden; /* Prevent overall scrolling */
        }

        /* Ensure proper chat layout on small screens */
        @media (max-height: 800px) {
            .chat-interface {
                height: 100%;
                max-height: 100vh;
            }
            
            /* Reduce padding and margins for smaller screens */
            .chat-toolbar {
                padding: 4px 8px !important;
                min-height: 28px !important;
            }
            
            .player-chips-area {
                padding: 4px 8px;
                min-height: auto;
            }
        }

        .chat-error {
            background: #ffebee;
            border: 1px solid #e57373;
            color: #c62828;
            padding: 12px;
            border-radius: var(--border-radius);
            margin-bottom: var(--grid-gap);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-error .material-icons {
            color: #e57373;
        }

        .chat-messages {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 0;
            padding: 8px; /* Reduced padding for tablet efficiency */
            overflow-y: scroll;
            overflow-x: hidden;
            border: 1px solid #e9ecef;
            font-size: calc(var(--base-font-size) * 0.95);
            height: calc(100vh - 280px);
            max-height: calc(100vh - 280px); /* Match height to prevent issues */
            min-height: 200px;
            flex-shrink: 0;
        }

        /* Responsive chat height for low-resolution displays */
        @media (max-height: 900px) {
            .chat-messages {
                height: calc(100vh - 240px);
                max-height: calc(100vh - 240px);
                min-height: 180px;
            }
        }

        @media (max-height: 800px) {
            .chat-messages {
                height: calc(100vh - 200px);
                max-height: calc(100vh - 200px);
                min-height: 150px;
            }
        }

        @media (max-height: 700px) {
            .chat-messages {
                height: calc(100vh - 180px);
                max-height: calc(100vh - 180px);
                min-height: 120px;
            }
        }

        .chat-message {
            margin-bottom: 6px; /* Reduced from var(--grid-gap) */
            padding: 8px; /* Reduced from calc(var(--padding-base) * 0.6) */
            border-radius: var(--border-radius);
            font-size: calc(var(--base-font-size) * 0.9);
            line-height: 1.3; /* Slightly tighter line height */
        }

        .chat-message.system {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .chat-message.player {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }c0913ecc15dbe48db519ac59b98e72bef9b74b78

        .chat-message.storyteller {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }

        .chat-input-area {
            display: flex;
            gap: var(--grid-gap);
            padding: 8px; /* Reduced from var(--padding-base) */
            background: var(--primary-color);
            border-top: 1px solid #e9ecef;
            min-height: calc(var(--input-height) + 16px); /* Adjusted for smaller padding */
            /* margin-top: var(--grid-gap); */
            flex-shrink: 0; /* Prevent input area from shrinking */
            position: sticky; /* Keep input area visible */
            bottom: 0;
            z-index: 10;
        }

        /* Responsive adjustments for chat input on small screens */
        @media (max-height: 800px) {
            .chat-input-area {
                padding: 6px;
                min-height: calc(var(--input-height) + 12px);
            }
            
            .chat-input {
                padding: calc(var(--padding-base) * 0.6);
                font-size: calc(var(--base-font-size) * 0.9);
            }
            
            .send-btn {
                padding: calc(var(--button-padding) * 0.8);
                font-size: calc(var(--base-font-size) * 0.9);
            }
        }

        .chat-input {
            flex: 1;
            padding: calc(var(--padding-base) * 0.7);
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            font-size: calc(var(--base-font-size) * 0.95);
            min-height: var(--input-height);
        }

        .chat-input:focus {
            outline: none;
            border-color: #74b9ff;
        }

        .send-btn {
            background: var(--action-gradient);
            border: none;
            color: white;
            padding: var(--button-padding);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            font-size: calc(var(--base-font-size) * 0.95);
            transition: all 0.2s;
            min-height: var(--input-height);
            min-width: calc(var(--touch-target-min) * 2);
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        /* Dropdown styles */
        .panel-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: calc(var(--padding-base) * 10);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: var(--border-radius);
            z-index: 1000;
            top: 100%;
            left: 0;
            border: 1px solid #e9ecef;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            color: #333;
            padding: var(--button-padding);
            text-decoration: none;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: calc(var(--base-font-size) * 0.95);
            min-height: var(--touch-target-min);
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item i {
            margin-right: 10px;
            width: 20px;
            font-size: calc(var(--base-font-size) * 1.1);
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: calc(var(--border-radius) * 0.7);
            font-size: calc(var(--base-font-size) * 0.85);
            font-weight: 500;
        }

        .status-indicator.online {
            background: #d4edda;
            color: #155724;
        }

        .status-indicator.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-indicator i {
            font-size: calc(var(--base-font-size) * 1);
        }

        /* Connection Status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: calc(var(--border-radius) * 0.7);
            font-size: calc(var(--base-font-size) * 0.85);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.offline {
            background: #e2e3e5;
            color: #6c757d;
        }

        .connection-status i {
            font-size: calc(var(--base-font-size) * 1);
        }

        /* Responsive Design */
        @media screen and (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
            
            .command-interface {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: 100%;
                overflow-y: auto;
            }
            
            .command-categories {
                grid-template-columns: repeat(auto-fit, minmax(calc(var(--padding-base) * 10), 1fr));
            }
        }

        /* Device-specific enhancements */
        .mode-ultra .mode-toggle {
            transform: scale(1.1);
        }

        .mode-highres .command-btn:hover,
        .mode-ultra .command-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(116, 185, 255, 0.5);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: calc(var(--grid-gap) * 0.8);
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: var(--border-radius);
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: var(--border-radius);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal-content {
            background: black;
            color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-gradient);
            border-radius: 12px 12px 0 0;
        }

        .settings-header h3 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .settings-body {
            padding: 20px;
            background: black;
            color: white;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        /* Chevron Collapsible Sections */
        .chevron-section {
            margin-bottom: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
        }

        .chevron-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #2a2a2a;
            border-radius: 8px 8px 0 0;
            transition: background 0.2s;
        }

        .chevron-header:hover {
            background: #333;
        }

        .chevron-header h4 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .chevron-icon {
            transition: transform 0.3s ease;
            color: #ccc;
        }

        .chevron-section.collapsed .chevron-icon {
            transform: rotate(-90deg);
        }

        .chevron-content {
            padding: 20px;
            background: #1a1a1a;
            border-radius: 0 0 8px 8px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .chevron-section.collapsed .chevron-content {
            max-height: 0;
            padding: 0 20px;
        }

        /* Compact/Tablet Mode */
        @media (max-width: 1200px) {
            .settings-modal-content {
                max-width: 90vw;
                max-height: 85vh;
            }
            
            .chevron-header {
                padding: 12px;
            }
            
            .chevron-content {
                padding: 15px;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
            
            .form-input {
                padding: 8px;
                font-size: 14px;
            }
            
            .action-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /* High Density Mode for Tablets */
        .compact-mode .settings-modal-content {
            max-width: 95vw;
            max-height: 90vh;
        }

        .compact-mode .chevron-header {
            padding: 10px;
        }

        .compact-mode .chevron-header h4 {
            font-size: 1rem;
        }

        .compact-mode .chevron-content {
            padding: 12px;
        }

        .compact-mode .form-group {
            margin-bottom: 8px;
        }

        .compact-mode .form-input {
            padding: 6px;
            font-size: 13px;
        }

        .compact-mode .action-btn {
            padding: 6px 10px;
            font-size: 13px;
        }

        .url-section label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .url-display {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .url-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #555;
            border-radius: var(--border-radius);
            background: #333;
            color: white;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .copy-btn {
            background: #667eea;
            border: none;
            border-radius: var(--border-radius);
            color: white;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .url-help {
            color: var(--text-tertiary);
            font-size: 0.875rem;
            margin: 0;
        }

        .session-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .session-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #333;
            border-radius: var(--border-radius);
            border: 1px solid #555;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
        }

        .status-dot.offline {
            background: #6b7280;
        }

        .session-form {
            padding: 15px;
            border: 1px solid #555;
            border-radius: var(--border-radius);
            background: #222;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            color: #ccc;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            border-radius: var(--border-radius);
            background: #333;
            color: white;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .local-session-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Session Clock Styles */
        .session-clock-container {
            display: flex;
            align-items: center;
            gap: calc(var(--grid-gap) * 0.5);
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: calc(var(--padding-base) * 0.5);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .clock-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .current-time {
            font-family: 'Courier New', monospace;
            font-size: calc(var(--base-font-size) * 1.1);
            font-weight: bold;
            color: #2c3e50;
            line-height: 1;
        }

        .session-info {
            font-size: calc(var(--base-font-size) * 0.75);
            color: #6c757d;
            line-height: 1;
            text-align: center;
            min-width: 60px;
        }

        .session-info.active {
            color: #28a745;
        }

        .session-info.caution {
            color: #ffc107;
        }

        .session-info.warning {
            color: #dc3545;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .session-info.ended {
            color: #6c757d;
            font-style: italic;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .clock-controls {
            display: flex;
            align-items: center;
        }

        .clock-btn {
            background: var(--action-gradient);
            border: none;
            color: white;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            min-width: 32px;
            min-height: 32px;
        }

        .clock-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.4);
        }

        .clock-btn i {
            font-size: 16px;
        }

        /* Session Timer Modal */
        .session-timer-modal {
            max-width: 500px;
        }

        .timer-form {
            display: flex;
            flex-direction: column;
            gap: var(--grid-gap);
        }

        .current-session {
            text-align: center;
            padding: var(--padding-base);
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }

        .current-session h4 {
            margin-bottom: var(--grid-gap);
            color: #495057;
        }

        .current-session p {
            margin: 4px 0;
            color: #6c757d;
        }

        .new-session {
            text-align: center;
        }

        .new-session h4 {
            margin-bottom: calc(var(--grid-gap) * 1.5);
            color: #495057;
        }

        .time-input-group {
            margin-bottom: var(--grid-gap);
        }

        .time-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .time-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .time-controls input[type="time"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: var(--base-font-size);
            background: white;
        }

        .ampm-toggle {
            display: flex;
            border: 1px solid #ced4da;
            border-radius: 4px;
            overflow: hidden;
        }

        .ampm-btn {
            padding: 8px 12px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.9);
            transition: all 0.2s;
            min-width: 40px;
        }

        .ampm-btn:hover {
            background: #f8f9fa;
        }

        .ampm-btn.active {
            background: var(--action-color);
            color: white;
        }

        .ampm-btn:not(:last-child) {
            border-right: 1px solid #ced4da;
        }

        .quick-add-section, .warning-section {
            margin-bottom: var(--grid-gap);
        }

        .quick-add-section label, .warning-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .quick-add-buttons, .warning-buttons {
            display: flex;
            gap: 8px;
        }

        .quick-btn, .warning-btn {
            flex: 1;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.9);
            transition: all 0.2s;
            text-align: center;
        }

        .quick-btn:hover, .warning-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .warning-btn.active {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .session-actions {
            margin-top: calc(var(--grid-gap) * 1.5);
            padding-top: var(--grid-gap);
            border-top: 1px solid #e9ecef;
        }

        .duration-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--grid-gap);
            margin-bottom: var(--grid-gap);
        }

        .duration-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: calc(var(--padding-base) * 0.8);
            background: var(--action-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            min-height: 70px;
            font-weight: 500;
        }

        .duration-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        .duration-btn:active {
            transform: translateY(0);
        }

        .duration-btn i {
            font-size: 20px;
        }

        .duration-btn span {
            font-size: calc(var(--base-font-size) * 0.9);
            line-height: 1;
        }

        .full-width {
            width: 100%;
            margin-top: var(--grid-gap);
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
            transform: translateY(-1px);
        }

        /* Modal Overlay Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--padding-base);
            border-bottom: 1px solid #e9ecef;
            background: var(--panel-gradient);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: var(--padding-base);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Dark theme support for modal */
        .dark-theme .modal-content {
            background: #343a40;
            color: #f8f9fa;
        }

        .dark-theme .modal-header {
            border-bottom-color: #495057;
        }

        .dark-theme .current-session {
            background: #495057;
            border-color: #6c757d;
        }

        .dark-theme .current-session h4 {
            color: #f8f9fa;
        }

        .dark-theme .current-session p {
            color: #adb5bd;
        }

        .dark-theme .new-session h4 {
            color: #f8f9fa;
        }

        .dark-theme .time-input-group label,
        .dark-theme .quick-add-section label,
        .dark-theme .warning-section label {
            color: #f8f9fa;
        }

        .dark-theme .time-controls input[type="time"] {
            background: #495057;
            border-color: #6c757d;
            color: #f8f9fa;
        }

        .dark-theme .ampm-toggle {
            border-color: #6c757d;
        }

        .dark-theme .ampm-btn {
            background: #495057;
            color: #f8f9fa;
            border-color: #6c757d;
        }

        .dark-theme .ampm-btn:hover {
            background: #5a6268;
        }

        .dark-theme .ampm-btn.active {
            background: var(--action-color);
            color: white;
        }

        .dark-theme .quick-btn,
        .dark-theme .warning-btn {
            background: #495057;
            border-color: #6c757d;
            color: #f8f9fa;
        }

        .dark-theme .quick-btn:hover,
        .dark-theme .warning-btn:hover {
            background: #5a6268;
        }

        .dark-theme .warning-btn.active {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .dark-theme .session-actions {
            border-top-color: #495057;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.9);
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--action-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* Dark theme support for clock */
        .dark-theme .session-clock-container {
            background: #343a40;
            border-color: #495057;
        }

        .dark-theme .current-time {
            color: #f8f9fa;
        }

        .dark-theme .session-info {
            color: #adb5bd;
        }

        .dark-theme .session-info.active {
            color: #40e759;
        }

        .dark-theme .session-info.caution {
            color: #ffc107;
        }

        .dark-theme .session-info.warning {
            color: #dc3545;
        }

        /* Responsive design for clock */
        @media (max-width: 768px) {
            .session-clock-container {
                padding: calc(var(--padding-base) * 0.4);
            }
            
            .current-time {
                font-size: var(--base-font-size);
            }
            
            .session-info {
                font-size: calc(var(--base-font-size) * 0.7);
            }
        }

        /* Smooth transitions for mode changes */
        * {
            transition: font-size 0.3s ease, padding 0.3s ease, margin 0.3s ease, 
                       min-height 0.3s ease, min-width 0.3s ease, border-radius 0.3s ease;
        }

        /* Notes Tab Styling */
        .notes-tab.active {
            border-bottom-color: var(--accent-color, #007bff) !important;
            color: var(--accent-color, #007bff) !important;
            font-weight: 600;
        }

        .notes-tab:hover {
            background: var(--bg-secondary, #f8f9fa);
            color: var(--accent-color, #007bff);
        }

        .notes-tab-content {
            animation: fadeIn 0.2s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="mode-tablet">
    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal" style="display: none;">
        <div class="settings-modal-content">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="close-btn" onclick="hideSettings()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            
            <div class="settings-body">
                <!-- Game Session (Chevron) -->
                <div class="chevron-section" id="game-session-section">
                    <div class="chevron-header" onclick="toggleChevron('game-session-section')">
                        <h4>
                            <i class="material-icons" style="margin-right: 10px;">games</i>
                            Game Session
                        </h4>
                        <i class="material-icons chevron-icon">expand_more</i>
                    </div>
                    <div class="chevron-content">
                        <div class="session-controls">
                            <div class="session-status" id="session-status">
                                <span class="status-dot offline"></span>
                                <span class="status-text">No active session</span>
                            </div>
                            
                            <!-- Supabase URL for this session -->
                            <div class="form-group" style="border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px;">
                                <label for="session-supabase-url">
                                    Supabase Project URL: 
                                    <a href="#" onclick="showSupabaseGuide()" style="color: #4CAF50; margin-left: 10px; text-decoration: underline; font-size: 0.9em;">
                                         Setup Guide
                                    </a>
                                </label>
                                <input type="text" id="session-supabase-url" placeholder="https://xxxxx.supabase.co" class="form-input">
                                <p style="color: #888; font-size: 0.9em; margin-top: 5px;">
                                    Use your own Supabase instance or leave blank to use defaults
                                </p>
                            </div>
                            
                            <div class="session-form" id="session-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="storyteller-name">Your Name (Storyteller):</label>
                                        <input type="text" id="storyteller-name" placeholder="Enter your name" class="form-input">
                                        <input type="hidden" id="dm-name-input">
                                    </div>
                                    <div class="form-group">
                                        <label for="new-session-code">Session Code:</label>
                                        <input type="text" id="new-session-code" placeholder="Enter session code" class="form-input">
                                        <input type="hidden" id="session-code-input">
                                    </div>
                                </div>
                                <button class="action-btn success" onclick="startNewGameSession()">
                                    <i class="material-icons">play_arrow</i>Start Game Session
                                </button>
                            </div>
                            <!-- Hidden elements for supabase compatibility -->
                            <div id="chat-session-controls" style="display: none;"></div>
                            <div id="chat-messages-container" style="display: none;"></div>
                            <div id="current-session-code" style="display: none;"></div>
                            <div id="chat-status" style="display: none;"></div>
                        </div>
                        
                        <!-- Player Connection URL (moved here) -->
                        <div class="url-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                            <label>Player Interface URL:</label>
                            <div class="url-display">
                                <input type="text" id="player-url" readonly class="url-input">
                                <button class="copy-btn" onclick="copyPlayerURL()">
                                    <i class="material-icons">content_copy</i>
                                </button>
                            </div>
                            <p class="url-help">Share this URL with your players to let them join the session</p>
                        </div>
                    </div>
                </div>

                <!-- Real-Time Chat Configuration (Chevron) -->
                <div class="chevron-section" id="chat-config-section">
                    <div class="chevron-header" onclick="toggleChevron('chat-config-section')">
                        <h4>
                            <i class="material-icons" style="margin-right: 10px;">chat</i>
                            Real-Time Chat Configuration
                        </h4>
                        <i class="material-icons chevron-icon">expand_more</i>
                    </div>
                    <div class="chevron-content">
                        <div class="config-status-display" id="config-status-display">
                            <span class="status-dot offline"></span>
                            <span class="status-text">Not Configured</span>
                        </div>
                        
                        <div id="settings-connection-status" class="connection-status offline" style="margin: 10px 0;">
                            <i class="material-icons">wifi_off</i>
                            Connection Status: Not Tested
                        </div>
                        
                        <div class="form-group">
                            <label for="supabase-url">Supabase Project URL:</label>
                            <input type="text" id="supabase-url" placeholder="https://xxxxx.supabase.co" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="supabase-key">Supabase API Key (anon/public):</label>
                            <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="form-input">
                        </div>
                        <div class="config-actions">
                            <button class="action-btn success" onclick="saveSupabaseConfig()">
                                <i class="material-icons">save</i>Save Configuration
                            </button>
                            <button class="action-btn primary" onclick="testSupabaseConnection()">
                                <i class="material-icons">wifi</i>Test Connection
                            </button>
                            <button class="action-btn warning" onclick="clearSupabaseConfig()">
                                <i class="material-icons">clear</i>Clear Config
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Display Mode (Standalone) -->
                <div class="settings-section">
                    <h4>Display Mode</h4>
                    <div class="mode-selector">
                        <div class="mode-option active" data-mode="tablet">Tablet</div>
                        <div class="mode-option" data-mode="compact">Compact</div>
                        <div class="mode-option" data-mode="highres">High Res</div>
                        <div class="mode-option" data-mode="ultra">Ultra</div>
                    </div>
                    <div class="device-info" id="device-info">
                        Standard Tablet Mode
                    </div>
                </div>
                
                <!-- Local Settings & Export (Standalone) -->
                <div class="settings-section">
                    <h4>Data Management</h4>
                    <div class="local-session-controls">
                        <button class="action-btn primary" onclick="showSessionManager()">
                            <i class="material-icons">folder</i>Local Sessions
                        </button>
                        <button class="action-btn warning" onclick="exportSession()">
                            <i class="material-icons">download</i>Export Data
                        </button>
                    </div>
                    <p style="color: #888; font-size: 0.9em; margin-top: 10px;">
                        Local Sessions: Manage saved game states<br>
                        Export Data: Download session and player data as JSON
                    </p>
                </div>
                
                <!-- Debug Controls -->
                <div class="settings-section">
                    <h4>Developer Options</h4>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="debug-toggle" onchange="toggleDebugMode()" style="margin-right: 8px;">
                            Show Debug Messages
                        </label>
                        <p style="color: #888; font-size: 0.9em; margin: 5px 0 0 0;">
                            Enable console debug output for troubleshooting
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="desktop-container">
        <!-- Header -->
        <header class="app-header">
            <div class="app-title">
                <i class="ra ra-crystal-ball"></i>
                <span>Story Teller Tool</span>
            </div>
            
            <div class="session-info">
                <span>Session: <strong id="session-name-display">New Session</strong></span>
                <span>Players: <strong id="player-count">0</strong></span>
                <span>Storyteller: <strong>DM Brad</strong></span>
                <span id="connection-status" class="connection-status offline">
                    <i class="material-icons">wifi_off</i>
                    Offline
                </span>
            </div>
            
            <div class="header-controls">
                <button class="header-btn" onclick="saveSession()">
                    <i class="material-icons">save</i>
                    Save
                </button>
                <button class="header-btn" onclick="toggleTheme()">
                    <i class="material-icons">brightness_6</i>
                    Theme
                </button>
                <button class="header-btn" onclick="showSettings()">
                    <i class="material-icons">settings</i>
                    Settings
                </button>
            </div>
        </header>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <div class="panel-dropdown">
                <button class="tab-selector" onclick="toggleDropdown('left-dropdown')">
                    <i class="material-icons">view_module</i>
                    Left Panel
                    <i class="material-icons">expand_more</i>
                </button>
                <div id="left-dropdown" class="dropdown-content">
                    <a class="dropdown-item" onclick="loadPanel('left', 'commands')">
                        <i class="ra ra-lightning-bolt"></i>Commands
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'npcs')">
                        <i class="ra ra-player"></i>NPCs
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'combat')">
                        <i class="ra ra-sword"></i>Combat
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'items')">
                        <i class="ra ra-gem"></i>Items
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'map')">
                        <i class="ra ra-treasure-map"></i>Map
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'admin')">
                        <i class="ra ra-gears"></i>Admin
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'chat')">
                        <i class="material-icons">chat</i>Chat
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'players')">
                        <i class="ra ra-player"></i>Players
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'quests')">
                        <i class="ra ra-scroll-unfurled"></i>Quests
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'notes')">
                        <i class="material-icons">note</i>Notes
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'dice')">
                        <i class="ra ra-dice-six"></i>Dice
                    </a>
                </div>
            </div>

            <div class="panel-dropdown">
                <button class="tab-selector" onclick="toggleDropdown('right-dropdown')">
                    <i class="material-icons">view_module</i>
                    Right Panel
                    <i class="material-icons">expand_more</i>
                </button>
                <div id="right-dropdown" class="dropdown-content">
                    <a class="dropdown-item" onclick="loadPanel('right', 'commands')">
                        <i class="ra ra-lightning-bolt"></i>Commands
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'npcs')">
                        <i class="ra ra-player"></i>NPCs
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'combat')">
                        <i class="ra ra-sword"></i>Combat
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'items')">
                        <i class="ra ra-gem"></i>Items
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'map')">
                        <i class="ra ra-treasure-map"></i>Map
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'admin')">
                        <i class="ra ra-gears"></i>Admin
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'chat')">
                        <i class="material-icons">chat</i>Chat
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'players')">
                        <i class="ra ra-player"></i>Players
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'quests')">
                        <i class="ra ra-scroll-unfurled"></i>Quests
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'notes')">
                        <i class="material-icons">note</i>Notes
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'dice')">
                        <i class="ra ra-dice-six"></i>Dice
                    </a>
                </div>
            </div>

            <button class="tab-selector" onclick="swapPanels()">
                <i class="material-icons">swap_horiz</i>
                Swap Panels
            </button>

            <button class="tab-selector" onclick="toggleSinglePanel()">
                <i class="material-icons">fullscreen</i>
                Single Panel
            </button>
            
            <div class="quick-connect-section">
                <button class="tab-selector quick-connect-btn" onclick="quickConnectToggle()" id="quick-connect-btn" title="Quick Connect">
                    <i class="material-icons">flash_on</i>
                </button>
                <!-- Fullscreen Toggle Button -->
                <button class="tab-selector" onclick="toggleFullscreen()" title="Toggle Fullscreen" style="margin-left: 5px; background: #4CAF50;">
                    <i class="material-icons" id="fullscreen-icon">fullscreen</i>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Left Panel -->
            <div class="panel" id="left-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="ra ra-lightning-bolt"></i>
                        <span id="left-panel-title">Command Center</span>
                    </div>
                    <div class="panel-controls">
                        <button class="panel-btn" onclick="refreshPanel('left')" title="Refresh">
                            <i class="material-icons">refresh</i>
                        </button>
                        <button class="panel-btn" onclick="pinPanel('left')" title="Pin Panel">
                            <i class="material-icons">push_pin</i>
                        </button>
                    </div>
                </div>
                <div class="panel-content" id="left-panel-content">
                    <!-- Commands Interface -->
                    <div class="command-interface">
                        <div class="command-categories">
                            <!-- Player Selection for Commands -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-player"></i>
                                    Selected Player
                                </div>
                                <div class="category-content">
                                    <div class="selected-player-display" id="selected-player-display">
                                        <span class="selected-player-name no-selection">Click on a player chip to select them</span>
                                    </div>
                                    <div class="selection-hint">
                                        <small> Click any player chip below the chat to select them</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loot Commands -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-gem"></i>
                                    Loot & Rewards
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn success" onclick="executeCommand('loot', 'handful_gold')">
                                             Gold
                                        </button>
                                        <button class="command-btn success" onclick="executeCommand('loot', 'treasure_chest')">
                                             Treasure
                                        </button>
                                        <button class="command-btn success" onclick="executeCommand('loot', 'magic_item')">
                                             Magic Item
                                        </button>
                                        <button class="command-btn success" onclick="executeCommand('loot', 'weapon')">
                                             Weapon
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Character Commands -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-player-lift"></i>
                                    Character Growth
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn" onclick="executeCommand('levelup')">
                                             Level Up
                                        </button>
                                        <button class="command-btn" onclick="executeCommand('achievement')">
                                             Achievement
                                        </button>
                                        <button class="command-btn" onclick="executeCommand('skill_train')">
                                             Train Skill
                                        </button>
                                        <button class="command-btn" onclick="executeCommand('experience')">
                                             Experience
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Health & Status -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-health"></i>
                                    Health & Status
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn success" onclick="executeCommand('heal')">
                                             Heal
                                        </button>
                                        <button class="command-btn danger" onclick="executeCommand('damage')">
                                             Damage
                                        </button>
                                        <button class="command-btn warning" onclick="executeCommand('stat_boost')">
                                             Stat Boost
                                        </button>
                                        <button class="command-btn warning" onclick="executeCommand('condition')">
                                             Condition
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Database Management - Commented out for space optimization -->
                            <!-- TODO: Move to Admin panel in future -->
                            <!--
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-anvil"></i>
                                    Database Management
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn warning" onclick="executeCommand('clean', 'old')" title="Remove messages older than 7 days">
                                             Clean Old
                                        </button>
                                        <button class="command-btn danger" onclick="executeCommand('clean', 'all')" title="Remove ALL session messages - be careful!">
                                             Clean All
                                        </button>
                                    </div>
                                    <div class="command-note">
                                        <small>Free Supabase: 500MB limit. Clean old messages to save space.</small>
                                    </div>
                                </div>
                            </div>
                            -->

                            <!-- Quick Actions -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-lightning-bolt"></i>
                                    Quick Actions
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn" onclick="executeCommand('commandlist')">
                                             Command List
                                        </button>
                                        <button class="command-btn" onclick="executeCommand('rest')">
                                             Rest
                                        </button>
                                        <button class="command-btn danger" onclick="executeCommand('murder_hobo')">
                                             Murder Hobo
                                        </button>
                                        <button class="command-btn success" onclick="executeCommand('heroic_deed')">
                                             Heroic Deed
                                        </button>
                                        <button class="command-btn warning" onclick="executeCommand('catastrophe')">
                                             Catastrophe
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Player Interaction -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-speech-bubbles"></i>
                                    Interact
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn" onclick="executeCommand('note')">
                                             Send Note
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Player Selector moved to Chat Panel -->
                        <!-- The player-selector has been moved to the chat interface between toolbar and input -->
                        
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="panel" id="right-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="material-icons">chat</i>
                        <span id="right-panel-title">Chat & Communication</span>
                    </div>
                    <div class="panel-controls">
                        <button class="panel-btn" onclick="clearChat()" title="Clear Chat">
                            <i class="material-icons">clear</i>
                        </button>
                        <button class="panel-btn" onclick="exportChat()" title="Export Chat">
                            <i class="material-icons">download</i>
                        </button>
                    </div>
                </div>
                <div class="panel-content" id="right-panel-content">
                    <!--  DEPRECATED: Static chat content removed in favor of dynamic loading  -->
                    <!-- This static chat implementation caused duplicate ID conflicts and inconsistent behavior -->
                    <!-- The dynamic chat template (loaded via loadPanel) provides better functionality and consistency -->
                    
                    <!-- REMOVED STATIC CONTENT:
                    <div class="chat-interface">
                        <div id="chat-error-message" class="chat-error" style="display: none;"></div>
                        <div class="chat-messages" id="right-chat-messages">
                            <div class="chat-message system">
                                <strong>System:</strong> Chat system ready. Start a session to begin messaging.
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" placeholder="Type your message or command..." id="chat-input">
                            <input type="hidden" id="chat-message-input">
                            <button class="send-btn" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                    -->
                    
                    <!-- Dynamic content will be loaded here via loadPanel() -->
                    <!-- This ensures consistent behavior between left and right panels -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- DCC Module System -->
    <script src="js/modules/advancedStorageManager.js"></script>
    <script src="js/modules/storageMigration.js"></script>
    <script src="js/modules/dccMechanics.js"></script>
    <script src="js/modules/rollCalculator.js"></script>
    <script src="js/modules/jsonDataLoader.js"></script>
    <script src="js/modules/characterData.js"></script>
    <script src="js/modules/skillsManager.js"></script>
    <script src="js/modules/equipmentBonusSystem.js"></script>
    <script src="js/modules/chatCommandParser.js"></script>
    <script src="js/modules/emojiProcessor.js"></script>
    
    <!-- Shared Chat Picker System -->
    <script src="../shared-modules/chatPickerManager.js"></script>
    <script src="../shared-modules/storyTellerChatPickerIntegration.js"></script>
    
    <script>
        // Test emoji processor after loading
        setTimeout(() => {
            if (window.emojiProcessor) {
                console.log(' Emoji processor loaded successfully');
                window.emojiProcessor.test();
            } else {
                console.error(' Emoji processor failed to load');
            }
        }, 100);
    </script>
    <script src="js/modules/dccUtilities.js"></script>
    
    <!-- ported StoryTeller.mobile.old js goes here -->
    <script src="js/modules/NPCGenerator.js"></script>
    <!-- end ported js -->
    
    <!-- Session Timer Module -->
    <script src="js/modules/sessionTimer.js"></script>
    
    <!-- Notes Manager Module -->
    <script src="js/modules/notesManager.js"></script>
    
    <!-- Dice Manager Module -->
    <script src="js/modules/diceManager.js"></script>
    
    <script src="js/modules/dccChatIntegration.js"></script>
    
    <!-- URL Encoder for Supabase connections -->
    <script src="js/supabaseUrlEncoder.js"></script>
    
    <!-- Chat System Modules -->
    <script src="js/modules/supabaseClient.js"></script>
    <script src="js/modules/chatParser.js"></script>
    <!-- Combat handler integrated into combat-manager-enhanced.js -->
    <!-- <script src="js/modules/combatHandler.js"></script> -->
    <script src="js/modules/messageFormatter.js"></script>
    <script src="js/modules/chatManager.js"></script>
    <script src="js/modules/chatAdapter.js"></script>
    <script src="js/modules/chatEffectsManager.js"></script>
    
    <!-- Image Hosting System -->
    <script src="js/githubTokenStorage.js"></script>
    <script src="js/githubImageHost.js"></script>
    <script src="js/multiImageHost.js"></script>
    <script src="js/chatImageSystem.js"></script>
    <script src="js/githubTokenDistributor.js"></script>
    <script src="js/githubImageTesting.js"></script>
    <script src="js/githubImageAutoInit.js"></script>
    
    <!-- Command Processing (Non-invasive) -->
    <script src="js/command-interceptor.js"></script>
    
    <!-- Core Application -->
    <script src="js/main.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/npc-generator.js"></script>
    <script src="js/quest-generator.js"></script>
    <script src="js/item-generator.js"></script>
    <script src="js/unified-map-renderer.js"></script>
    <script src="js/map-editor.js"></script>
    <script src="js/unified-storage-db.js"></script>
    <script src="js/PlayerMapViewerLocal.js"></script>
    <script src="js/maps-manager.js"></script>
    
    <!-- Players Panel Module -->
    <script src="js/characterImportProfile.js"></script>
    <script src="js/characterSyncManager.js"></script>
    <script src="js/v4NetworkBridge.js"></script>
    <script src="js/storyTellerPlayersPanel.js"></script>
    <!-- Map Synchronization System -->
    <!-- Map Sync System Scripts -->
    <script src="js/MapDataFormatter.js"></script>
    <script src="js/MapSyncManager.js"></script>
    <script src="js/MapClientManager.js"></script>
    <script src="js/MapSyncAdapter.js"></script>
    <script src="js/PlayerPositionTracker.js"></script>
    <script src="js/StorytellerIntegration.js"></script>
    <!-- End Map Sync -->
    <!-- DISABLED: Enhanced combat system conflicts with combatSystem-ST.js -->
    <!-- <script src="js/combat-manager-enhanced.js"></script> -->
    <script>
        // Enhanced stub for updateConnectedPlayers to prevent errors during loading
        // This will be replaced by the full function defined later in the HTML
        if (typeof window.updateConnectedPlayers === 'undefined') {
            console.log(' Setting up updateConnectedPlayers stub BEFORE supabase-chat.js');
            window.updateConnectedPlayers = function(players = []) {
                console.log(' Temporary updateConnectedPlayers stub called with:', players.length, 'players');
                // Store the players for when the real function loads
                window._pendingConnectedPlayers = players;
                console.log(' Stored pending players for later processing');
            };
            console.log(' updateConnectedPlayers stub is now available in window');
        } else {
            console.log(' updateConnectedPlayers already exists in window');
        }
    </script>
    <script src="js/supabase-chat.js"></script>
    <script src="js/combatSystem-ST.js"></script>
    <script src="js/map-sharing.js"></script>
    <script src="js/player-data-parser.js"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        let selectedPlayer = 'Storyteller'; // Default to storyteller
        let leftPanelContent = 'commands';
        let rightPanelContent = 'chat';
        let currentMode = 'tablet';
        let deviceInfo = {};

        // Chat system loading flags
        window.isChatEffectsLoaded = false;
        window.isEmojiProcessorLoaded = false;

        // Function to wait for chat dependencies and then initialize right panel
        function waitForChatDependenciesAndInitialize() {
            const checkCount = window.chatDependencyCheckCount || 0;
            window.chatDependencyCheckCount = checkCount + 1;
            
            // Check if the actual objects exist instead of relying on flags
            const chatEffectsReady = !!(window.chatEffectsManager && typeof window.chatEffectsManager.processMessage === 'function');
            const emojiReady = !!(window.emojiProcessor && typeof window.emojiProcessor.processMessage === 'function');
            
            // Only log every 10 checks to reduce spam
            if (checkCount % 10 === 0 || checkCount < 3) {
                console.log(` Chat dependency check #${checkCount}:`, {
                    chatEffectsReady,
                    emojiReady,
                    chatEffectsManager: !!window.chatEffectsManager,
                    emojiProcessor: !!window.emojiProcessor
                });
            }

            if (chatEffectsReady && emojiReady) {
                // Both dependencies loaded, wait additional 100ms then initialize
                console.log(' All chat dependencies loaded, initializing right panel...');
                setTimeout(() => {
                    loadPanel('right', rightPanelContent);
                    console.log(' Right panel chat initialized with dependencies');
                }, 100);
            } else if (checkCount > 30) {
                // Give up after 3 seconds and initialize anyway
                console.warn(' Chat dependencies taking too long, initializing chat anyway...');
                loadPanel('right', rightPanelContent);
                console.log(' Chat initialized without full dependencies (fallback mode)');
            } else {
                // Not ready yet, check again in 100ms
                setTimeout(waitForChatDependenciesAndInitialize, 100);
            }
        }

        // Device Detection and Mode Management
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const screenWidth = window.screen.width;
            const screenHeight = window.screen.height;
            const pixelRatio = window.devicePixelRatio || 1;
            const dpi = Math.sqrt(screenWidth * screenWidth + screenHeight * screenHeight) / Math.sqrt(screenWidth / pixelRatio * screenWidth / pixelRatio + screenHeight / pixelRatio * screenHeight / pixelRatio) * pixelRatio;
            
            deviceInfo = {
                isOnePlusPad: userAgent.includes('OnePlus') || (screenWidth === 2800 && screenHeight === 2000),
                isHighRes: dpi >= 200 || pixelRatio >= 2,
                screenWidth: screenWidth,
                screenHeight: screenHeight,
                pixelRatio: pixelRatio,
                estimatedDPI: Math.round(dpi),
                userAgent: userAgent
            };

            // Auto-select best mode
            let recommendedMode = 'tablet';
            if (deviceInfo.isOnePlusPad) {
                recommendedMode = 'ultra';
            } else if (deviceInfo.isHighRes) {
                recommendedMode = 'highres';
            }

            // Update device info display
            updateDeviceInfo();
            
            // Auto-switch to recommended mode if it's better than current
            if (recommendedMode !== 'tablet' && currentMode === 'tablet') {
                switchMode(recommendedMode);
            }

            console.log('Device Detection:', deviceInfo);
            console.log('Recommended Mode:', recommendedMode);
        }

        function updateDeviceInfo() {
            const deviceInfoEl = document.getElementById('device-info');
            let infoText = '';
            
            if (deviceInfo.isOnePlusPad) {
                infoText = `OnePlus Pad Detected<br>${deviceInfo.screenWidth}${deviceInfo.screenHeight}`;
            } else if (deviceInfo.isHighRes) {
                infoText = `High-DPI Display<br>~${deviceInfo.estimatedDPI} DPI`;
            } else {
                infoText = `Standard Display<br>${deviceInfo.screenWidth}${deviceInfo.screenHeight}`;
            }
            
            deviceInfoEl.innerHTML = infoText;
        }

        function switchMode(mode) {
            if (mode === currentMode) return;
            
            currentMode = mode;
            
            // Remove all mode classes
            document.body.classList.remove('mode-tablet', 'mode-highres', 'mode-ultra');
            
            // Add new mode class
            document.body.classList.add(`mode-${mode}`);
            
            // Update mode selector
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.mode === mode) {
                    option.classList.add('active');
                }
            });
            
            // Add feedback message
            const modeNames = {
                'tablet': 'Standard Tablet Mode',
                'highres': 'High Resolution Mode',
                'ultra': 'Ultra Premium Mode'
            };
            
            addChatMessage(`Switched to ${modeNames[mode]}`, 'system');
            
            console.log(`Switched to mode: ${mode}`);
        }

        // Force load chat panel for debugging
        window.forceChatLoad = function() {
            console.log(' Force loading chat panel...');
            rightPanelContent = 'chat';
            loadPanel('right', 'chat');
            console.log(' Chat panel force-loaded');
        };

        // Initialize mode selector and DCC systems
        document.addEventListener('DOMContentLoaded', function() {
            // Set storyteller flag immediately - this is the StoryTeller interface
            window.isStoryteller = true;
            window.isStoryTeller = true;
            
            // Detect device on load
            detectDevice();
            
            // Initialize connection status
            updateConnectionStatus('Offline', 'offline');
            updateSettingsConnectionStatus('Not tested', 'offline');
            
            // Initialize command interceptor for chat message processing
            if (typeof initializeCommandInterceptor === 'function') {
                const interceptorInitialized = initializeCommandInterceptor();
                if (interceptorInitialized) {
                    console.log(' Command Interceptor initialized for StoryTeller');
                } else {
                    console.warn(' Command Interceptor failed to initialize');
                }
            } else {
                console.warn(' Command Interceptor not available');
            }
            
            // Load Supabase configuration from browser storage
            const supabaseConfig = loadSupabaseConfig();
            
            if (supabaseConfig) {
                // Configuration found - attempt auto-connection
                addChatMessage(' Supabase configuration found, testing connection...', 'system');
                
                // Wait a moment for modules to load, then test connection
                setTimeout(async () => {
                    try {
                        await testSupabaseConnection();
                    } catch (error) {
                        console.error('Auto-connection test failed:', error);
                        updateConnectionStatus('Auto-connect failed', 'error');
                    }
                }, 1000);
                
            } else {
                // No configuration found - open settings modal
                addChatMessage(' No Supabase configuration found. Opening settings...', 'system');
                setTimeout(() => {
                    showSettings();
                    addChatMessage(' Please configure Supabase settings to enable real-time chat', 'system');
                }, 1500);
            }
            
            // Setup mode selector
            document.querySelectorAll('.mode-option').forEach(option => {
                option.addEventListener('click', () => {
                    switchMode(option.dataset.mode);
                });
            });
            
            // Initialize DCC Chat Integration if modules are loaded
            if (typeof DCCChatIntegration !== 'undefined') {
                try {
                    window.dccChatIntegration = new DCCChatIntegration();
                    addChatMessage('DCC systems initialized successfully!', 'system');
                } catch (error) {
                    console.error('DCC initialization error:', error);
                    addChatMessage('DCC systems initialization failed - using fallback mode', 'system');
                }
            } else {
                addChatMessage('DCC modules not loaded - using simulation mode', 'system');
            }
            
            // Initialize panels with default content
            // Wait for chat dependencies before initializing right panel
            waitForChatDependenciesAndInitialize();
            
            // Update left panel title to match the content
            document.getElementById('left-panel-title').textContent = getPanelTitle(leftPanelContent);
        });

        // Toggle mode panel
        function toggleModePanel() {
            const toggle = document.getElementById('mode-toggle');
            toggle.classList.toggle('collapsed');
        }

        // Panel and UI Functions
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('show');
            
            // Close other dropdowns
            document.querySelectorAll('.dropdown-content').forEach(el => {
                if (el.id !== dropdownId) {
                    el.classList.remove('show');
                }
            });
        }

        function loadPanel(panel, content) {
            console.log(`Loading ${content} in ${panel} panel`);
            
            // Remove private messages scroll CSS if switching away from notes panel
            if (content !== 'notes') {
                removePrivateMessagesScrollCSS();
            }
            
            if (panel === 'left') {
                leftPanelContent = content;
                document.getElementById('left-panel-title').textContent = getPanelTitle(content);
                document.getElementById('left-panel-content').innerHTML = getPanelContent(content, panel);
            } else {
                rightPanelContent = content;
                document.getElementById('right-panel-title').textContent = getPanelTitle(content);
                document.getElementById('right-panel-content').innerHTML = getPanelContent(content, panel);
            }
            
            // Close dropdowns
            document.querySelectorAll('.dropdown-content').forEach(el => {
                el.classList.remove('show');
            });
            
            // Load chat history if chat panel is loaded
            if (content === 'chat') {
                setTimeout(() => {
                    // Set up chat functionality for this panel
                    setupChatPanel(panel);
                    
                    if (window.loadRecentChatHistory) {
                        window.loadRecentChatHistory();
                    } else {
                        // If no chat history function, just reset the container
                        resetChatContainer();
                    }
                }, 100); // Small delay to ensure DOM is ready
            }
            
            // Initialize notes panel if notes panel is loaded
            if (content === 'notes') {
                setTimeout(() => {
                    if (typeof initializeNotesPanel === 'function') {
                        initializeNotesPanel();
                    }
                    
                    // Check if Private Messages tab is active and add scroll CSS if needed
                    const privateMessagesTab = document.getElementById('private-messages-tab');
                    if (privateMessagesTab && privateMessagesTab.style.display !== 'none') {
                        console.log(' Notes panel loaded with Private Messages tab active, adding scroll CSS...');
                        addPrivateMessagesScrollCSS();
                    }
                    
                    // Update private messages panel when notes panel is loaded
                    if (typeof updateStoryTellerPrivateMessagesPanel === 'function') {
                        console.log(' Notes panel loaded, updating private messages...');
                        updateStoryTellerPrivateMessagesPanel();
                    }
                }, 100); // Small delay to ensure DOM is ready
            }
            
            // Initialize dice panel if dice panel is loaded
            if (content === 'dice') {
                setTimeout(() => {
                    if (typeof initializeDicePanel === 'function') {
                        initializeDicePanel();
                    }
                }, 100); // Small delay to ensure DOM is ready
            }
            
            // Initialize enhanced combat panel if combat panel is loaded
            if (content === 'combat') {
                setTimeout(() => {
                    if (typeof initializeCombatManager === 'function') {
                        console.log(' Initializing enhanced combat panel...');
                        initializeCombatManager();
                        
                        // Refresh combat display if already active
                        if (typeof refreshCombatDisplay === 'function') {
                            refreshCombatDisplay();
                        }
                    }
                }, 100); // Small delay to ensure DOM is ready
            }
            
            // Initialize map editor and maps panel if map panel is loaded
            if (content === 'map') {
                setTimeout(() => {
                    if (typeof initializeMapEditor === 'function') {
                        initializeMapEditor();
                    }
                    if (typeof initializeMapsPanel === 'function') {
                        initializeMapsPanel();
                    }
                }, 100); // Small delay to ensure DOM is ready
            }
            
            addChatMessage(`${getPanelTitle(content)} loaded in ${panel} panel`, 'system');
        }

        function getPanelTitle(content) {
            const titles = {
                'commands': 'Command Center',
                'npcs': 'NPC Manager',
                'combat': 'Combat Tracker',
                'items': 'Item Generator',
                'map': 'Map Editor',
                'admin': 'Admin Panel',
                'chat': 'Chat & Communication',
                'players': 'Player Management',
                'quests': 'Quest Tracker',
                'notes': 'Session Notes',
                'dice': 'Dice Roller'
            };
            return titles[content] || content;
        }

        function getPanelContent(content, panel = 'left') {
            switch (content) {
                case 'commands':
                    return `
                        <!-- Commands Interface -->
                        <div class="command-interface">
                            <div class="command-categories">
                                <!-- Loot Commands -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-gem"></i>
                                        Loot & Rewards
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn success" onclick="executeCommand('loot', 'handful_gold')">
                                                 Gold
                                            </button>
                                            <button class="command-btn success" onclick="executeCommand('loot', 'treasure_chest')">
                                                 Treasure
                                            </button>
                                            <button class="command-btn success" onclick="executeCommand('loot', 'magic_item')">
                                                 Magic Item
                                            </button>
                                            <button class="command-btn success" onclick="executeCommand('loot', 'weapon')">
                                                 Weapon
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Character Commands -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-player-lift"></i>
                                        Character Growth
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn" onclick="executeCommand('levelup')">
                                                 Level Up
                                            </button>
                                            <button class="command-btn" onclick="executeCommand('achievement')">
                                                 Achievement
                                            </button>
                                            <button class="command-btn" onclick="executeCommand('skill_train')">
                                                 Train Skill
                                            </button>
                                            <button class="command-btn" onclick="executeCommand('experience')">
                                                 Experience
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Health & Status -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-health"></i>
                                        Health & Status
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn success" onclick="executeCommand('heal')">
                                                 Heal
                                            </button>
                                            <button class="command-btn danger" onclick="executeCommand('damage')">
                                                 Damage
                                            </button>
                                            <button class="command-btn warning" onclick="executeCommand('stat_boost')">
                                                 Stat Boost
                                            </button>
                                            <button class="command-btn warning" onclick="executeCommand('condition')">
                                                 Condition
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-lightning-bolt"></i>
                                        Quick Actions
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn" onclick="executeCommand('rest')">
                                                 Rest
                                            </button>
                                            <button class="command-btn danger" onclick="executeCommand('murder_hobo')">
                                                 Murder Hobo
                                            </button>
                                            <button class="command-btn success" onclick="executeCommand('heroic_deed')">
                                                 Heroic Deed
                                            </button>
                                            <button class="command-btn warning" onclick="executeCommand('catastrophe')">
                                                 Catastrophe
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Player Selector -->
                            <div class="player-selector">
                                <h4>Connected Players</h4>
                                <div class="player-list" id="player-list">
                                    <div class="player-item" id="dm-player">
                                        <div class="player-name">Storyteller (You)</div>
                                        <div class="player-stats">Session Master</div>
                                    </div>
                                    <!-- Connected players will be populated here dynamically -->
                                </div>
                                <div class="no-players" id="no-players" style="display: none; padding: 15px; text-align: center; color: #666;">
                                    No players connected yet. Share the player URL to invite players!
                                </div>
                            </div>
                        </div>
                    `;
                
                case 'admin':
                    return `
                        <!-- Admin Panel -->
                        <div class="admin-interface">
                            <div class="admin-categories">
                                <!-- Database Management -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-anvil"></i>
                                        Database Management
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn warning" onclick="executeCommand('clean', 'old')" title="Remove messages older than 7 days">
                                                 Clean Old
                                            </button>
                                            <button class="command-btn danger" onclick="executeCommand('clean', 'all')" title="Remove ALL session messages - be careful!">
                                                 Clean All
                                            </button>
                                        </div>
                                        <div class="command-note">
                                            <small>Free Supabase: 500MB limit. Clean old messages to save space.</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- System Management -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-gears"></i>
                                        System Management
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn" onclick="exportAllData()" title="Export all session data">
                                                 Export Data
                                            </button>
                                            <button class="command-btn" onclick="showBackupStatus()" title="Check backup status">
                                                 Backup Status
                                            </button>
                                            <button class="command-btn warning" onclick="resetSession()" title="Reset current session">
                                                 Reset Session
                                            </button>
                                            <button class="command-btn storage" onclick="showStorageStats()" title="View storage usage and manage data">
                                                 Storage Manager
                                            </button>
                                            <button class="command-btn primary" onclick="migrateToIndexedDB()" title="Move large data to IndexedDB">
                                                 Migrate Storage
                                            </button>
                                        </div>
                                        <div class="command-note">
                                            <small>System administration and maintenance tools.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                
                case 'npcs':
                    return `
                        <!-- Enhanced NPC Manager - Redesigned for Tablets -->
                        <div class="npc-panel-container">
                            <!-- Tab Navigation -->
                            <div class="npc-tabs">
                                <button class="npc-tab active" onclick="switchNPCTab('new')" data-tab="new">
                                    <i class="ra ra-user-plus"></i> New NPC
                                </button>
                                <button class="npc-tab" onclick="switchNPCTab('saved')" data-tab="saved">
                                    <i class="ra ra-users"></i> Saved NPCs
                                    <span class="saved-count" id="saved-npc-count">0</span>
                                </button>
                            </div>

                            <!-- New NPC Tab Content -->
                            <div class="npc-tab-content active" id="new-npc-tab">
                                <!-- Quick Generate Buttons -->
                                <div class="npc-quick-generate">
                                    <button class="npc-type-btn friendly" onclick="generateNPCType('npc')">
                                        <i class="ra ra-user"></i>
                                        <span> Friendly NPC</span>
                                    </button>
                                    <button class="npc-type-btn encounter" onclick="generateNPCType('encounter')">
                                        <i class="ra ra-sword"></i>
                                        <span> Encounter</span>
                                    </button>
                                </div>

                                <!-- Current NPC Display -->
                                <div class="npc-current-display" id="generated-npc">
                                    <div class="npc-placeholder">
                                        <i class="ra ra-user-plus"></i>
                                        <p>Click a button above to generate an NPC</p>
                                    </div>
                                </div>

                                <!-- Manual Controls (Hidden by default) -->
                                <div class="manual-controls" id="manual-controls" style="display: none;">
                                    <div class="manual-header">
                                        <h5><i class="ra ra-settings"></i> Edit NPC</h5>
                                        <button class="btn-close" onclick="hideManualControls()"></button>
                                    </div>
                                    <div class="controls-grid">
                                        <div class="control-group">
                                            <label for="manual-name">Name</label>
                                            <input type="text" id="manual-name" class="control-input">
                                        </div>
                                        <div class="control-group">
                                            <label for="manual-level">Level</label>
                                            <input type="number" id="manual-level" class="control-input" min="0" max="10">
                                        </div>
                                        <div class="control-group">
                                            <label for="manual-race">Race</label>
                                            <select id="manual-race" class="control-select" onchange="handleNPCHeritageSelection()"></select>
                                        </div>
                                        <div class="control-group">
                                            <label for="manual-background">Background</label>
                                            <select id="manual-background" class="control-select"></select>
                                        </div>
                                        <div class="control-group">
                                            <label for="manual-class">Class</label>
                                            <select id="manual-class" class="control-select"></select>
                                        </div>
                                    </div>
                                    <div class="manual-actions">
                                        <button class="btn-secondary" onclick="applyManualChanges()">Apply Changes</button>
                                        <button class="btn-secondary" onclick="hideManualControls()">Cancel</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Saved NPCs Tab Content -->
                            <div class="npc-tab-content" id="saved-npc-tab">
                                <!-- Filter Controls -->
                                <div class="saved-controls">
                                    <select id="npc-filter" class="filter-select" onchange="filterSavedNPCs()">
                                        <option value="all">All NPCs</option>
                                        <option value="npc"> Friendly</option>
                                        <option value="encounter"> Encounters</option>
                                    </select>
                                    <button class="clear-btn" onclick="clearAllNPCs()">
                                        <i class="ra ra-trash"></i> Clear All
                                    </button>
                                </div>

                                <!-- Saved NPCs Grid -->
                                <div class="saved-npcs-container" id="saved-npcs-container">
                                    <div class="no-npcs">
                                        <i class="ra ra-users"></i>
                                        <p>No saved NPCs yet</p>
                                        <p>Generate and save some NPCs to see them here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                
                case 'combat':
                    return `
                        <div class="visual-combat-manager">
                            <!-- Ultra-Compact Header -->
                            <div class="combat-status-bar">
                                <div class="status-inline">
                                    <span class="combat-icon"></span>
                                    <span>Combat</span>
                                    <span class="divider">|</span>
                                    <span>Active: <strong id="combat-active-status">No</strong></span>
                                    <span class="divider">|</span>
                                    <span>Round: <strong id="combat-round">0</strong></span>
                                    <span class="divider">|</span>
                                    <span>Turn: <strong id="current-turn-name">-</strong></span>
                                </div>
                                <div class="combat-controls-inline">
                                    <button class="btn-compact start-combat" onclick="startCombatInitiative()" id="start-combat-btn">Start</button>
                                    <button class="btn-compact turn-order" onclick="announceTurnOrder()" id="announce-turn-btn" style="display: none;">Turn Order</button>
                                    <button class="btn-compact next-turn" onclick="advanceTurn()" id="next-turn-btn" style="display: none;">Next</button>
                                    <button class="btn-compact clear-combat" onclick="clearInitiative()" id="clear-initiative-btn" style="display: none;">Reset</button>
                                </div>
                            </div>

                            <!-- Enemy Builder Section -->
                            <div class="enemy-builder">
                                <div class="builder-row">
                                    <select id="level-selector" class="level-select" onchange="loadEnemiesForLevel(this.value)">
                                        <option value="">Select Level...</option>
                                        ${Array.from({length: 30}, (_, i) => `<option value="floor_${i+1}">Level ${i+1}</option>`).join('')}
                                    </select>
                                    <select id="enemy-selector" class="enemy-select" disabled onchange="loadEnemyAttacks(this.value)">
                                        <option value="">Choose Enemy...</option>
                                    </select>
                                    <select id="enemy-attack-selector" class="attack-select" disabled>
                                        <option value="">Default Attack</option>
                                    </select>
                                    <button class="btn-add-enemy" onclick="addEnemyToCombat()" disabled id="add-enemy-btn">
                                        <span class="icon">+</span> Add Enemy
                                    </button>
                                </div>
                                <div class="current-enemies" id="current-enemies">
                                    <!-- Enemy chips will appear here -->
                                </div>
                            </div>

                            <!-- Visual Initiative Tracker -->
                            <div class="initiative-arena" id="initiative-arena">
                                <div class="arena-empty" id="arena-empty">
                                    <div class="empty-icon"></div>
                                    <h3>Ready for Battle</h3>
                                    <p>Add enemies above, then start combat.<br>Players will roll initiative using their DEX buttons.</p>
                                </div>
                                <div class="combatants-grid" id="combatants-grid" style="display: none;">
                                    <!-- Player and enemy cards will appear here -->
                                </div>
                            </div>

                            <!-- Hidden compatibility elements -->
                            <div style="display: none;">
                                <span id="current-enemy-name">-</span>
                                <span id="enemy-hp">0</span>
                                <span id="enemy-max-hp">0</span>
                                <span id="enemy-ac">10</span>
                                <div id="initiative-list"></div>
                                <div id="action-queue"></div>
                                <div id="combat-log"></div>
                            </div>
                        </div>
                    `;
                
                case 'items':
                    return `
                        <div class="item-generator">
                            <h4>Item Generator</h4>
                            <div class="generator-controls">
                                <select id="item-type" class="form-select">
                                    <option value="weapon">Weapon</option>
                                    <option value="armor">Armor</option>
                                    <option value="treasure">Treasure</option>
                                    <option value="potion">Potion</option>
                                </select>
                                <button class="action-btn primary" onclick="generateItem()">
                                    <i class="ra ra-gem"></i>Generate Item
                                </button>
                            </div>
                            <div id="generated-item-display" class="item-display">
                                <p class="placeholder-text">Click "Generate Item" to create loot</p>
                            </div>
                        </div>
                    `;
                
                case 'map':
                    return `
                        <div class="maps-panel">
                            <div class="maps-header">
                                <h4>
                                    <i class="material-icons">map</i>
                                    Battle Maps
                                </h4>
                                <div class="maps-controls">
                                    <button class="maps-btn new" onclick="openMapEditor()" title="Create New Map">
                                        <i class="material-icons">add</i>New Map
                                    </button>
                                    <button class="maps-btn" onclick="importMapFromFile()" title="Import Map File">
                                        <i class="material-icons">upload</i>Import
                                    </button>
                                    <button class="maps-btn" onclick="exportAllMaps()" title="Export All Maps">
                                        <i class="material-icons">download</i>Export All
                                    </button>
                                </div>
                            </div>
                            
                            <div class="maps-container">
                                <div class="maps-list-container">
                                    <div class="maps-list-header">
                                        <h5>Saved Maps</h5>
                                        <div class="maps-list-controls">
                                            <button class="maps-btn" onclick="refreshMapsList()" title="Refresh Maps List" style="padding: 4px; min-height: 24px;">
                                                <i class="material-icons" style="font-size: 16px;">refresh</i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="maps-list" id="maps-list">
                                        <!-- Maps will be populated by JavaScript -->
                                    </div>
                                </div>
                                
                                <div class="maps-viewer-container">
                                    <div class="maps-viewer-header">
                                        <div class="map-title-display" id="map-title-display">No map selected</div>
                                        <div class="map-viewer-controls">
                                            <button class="maps-btn" onclick="editCurrentMap()" title="Edit Current Map" id="edit-map-btn" style="display: none;">
                                                <i class="material-icons">edit</i>Edit
                                            </button>
                                            <button class="maps-btn" onclick="duplicateCurrentMap()" title="Duplicate Map" id="duplicate-map-btn" style="display: none;">
                                                <i class="material-icons">content_copy</i>Duplicate
                                            </button>
                                            <button class="maps-btn" onclick="exportCurrentMap()" title="Export Map" id="export-map-btn" style="display: none;">
                                                <i class="material-icons">download</i>Export
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="map-viewer-content" id="map-viewer-content">
                                        <div class="map-viewer-placeholder">
                                            <i class="material-icons">map</i>
                                            <h3>Select a Map</h3>
                                            <p>Choose a map from the list to view it here, or create a new one to get started.</p>
                                        </div>
                                    </div>
                                    
                                    <div class="map-stats" id="map-stats" style="display: none;">
                                        <div class="map-stats-item">
                                            <i class="material-icons">grid_on</i>
                                            <span id="map-size-display">Size: -</span>
                                        </div>
                                        <div class="map-stats-item">
                                            <i class="material-icons">palette</i>
                                            <span id="map-tileset-display">Tileset: -</span>
                                        </div>
                                        <div class="map-stats-item">
                                            <i class="material-icons">schedule</i>
                                            <span id="map-modified-display">Modified: -</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                
                case 'chat':
                    // Generate unique IDs based on panel location
                    const chatId = `${panel}-chat-messages`;
                    const inputId = `${panel}-chat-input`;
                    const hiddenInputId = `${panel}-chat-message-input`;
                    
                    return `
                        <div class="chat-interface">
                            <!-- Error message container for Supabase -->
                            <div id="chat-error-message" class="chat-error" style="display: none;"></div>
                            
                            <div class="chat-messages" id="${chatId}">
                                <div class="chat-message system">
                                    <strong>System:</strong> Chat system ready. Start a session to begin messaging.
                                </div>
                            </div>
                            
                            <!-- Compact chat toolbar between messages and input -->
                            <div class="chat-toolbar" style="
                                display: flex; 
                                align-items: center; 
                                justify-content: space-between; 
                                padding: 6px 10px; 
                                background: var(--bg-secondary); 
                                border-top: 1px solid var(--border-color);
                                border-bottom: 1px solid var(--border-color);
                                margin: 0;
                                min-height: 34px;
                                font-size: 0.75em;
                            ">
                                <div class="chat-info" style="color: var(--text-tertiary); font-size: 0.8em;">
                                    <i class="material-icons" style="font-size: 14px; vertical-align: middle;">chat</i>
                                    <span style="margin-left: 4px;">Chat</span>
                                </div>
                                <div class="chat-actions" style="display: flex; gap: 6px;">
                                    <button id="chat-image-upload-btn" title="Upload Image" style="
                                        background: none; 
                                        border: 1px solid var(--border-color); 
                                        color: var(--text-secondary);
                                        padding: 4px 8px; 
                                        border-radius: 4px; 
                                        cursor: pointer; 
                                        font-size: 0.75em;
                                        display: flex;
                                        align-items: center;
                                        gap: 3px;
                                        transition: all 0.2s;
                                    " onmouseover="this.style.background='var(--accent-color)'; this.style.color='white'; this.style.borderColor='var(--accent-color)'" 
                                       onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)'; this.style.borderColor='var(--border-color)'">
                                        <span></span>
                                        <span>Image</span>
                                    </button>
                                    <button onclick="showChatPicker('${panel}')" title="Chat Picker (Emojis & Effects)" style="
                                        background: none; 
                                        border: 1px solid var(--border-color); 
                                        color: var(--text-secondary);
                                        padding: 4px 8px; 
                                        border-radius: 4px; 
                                        cursor: pointer; 
                                        font-size: 0.75em;
                                        display: flex;
                                        align-items: center;
                                        gap: 3px;
                                        transition: all 0.2s;
                                    " onmouseover="this.style.background='var(--accent-color)'; this.style.color='white'; this.style.borderColor='var(--accent-color)'" 
                                       onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)'; this.style.borderColor='var(--border-color)'">
                                        <span></span>
                                    </button>
                                    <button onclick="clearChat()" title="Clear Chat" style="
                                        background: none; 
                                        border: 1px solid var(--border-color); 
                                        color: var(--text-secondary);
                                        padding: 4px 8px; 
                                        border-radius: 4px; 
                                        cursor: pointer; 
                                        font-size: 0.75em;
                                        display: flex;
                                        align-items: center;
                                        gap: 3px;
                                        transition: all 0.2s;
                                    " onmouseover="this.style.background='var(--danger)'; this.style.color='white'; this.style.borderColor='var(--danger)'" 
                                       onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)'; this.style.borderColor='var(--border-color)'">
                                        <i class="material-icons" style="font-size: 12px;">clear</i>
                                        <span>Clear</span>
                                    </button>
                                    <button onclick="exportChat()" title="Export Chat" style="
                                        background: none; 
                                        border: 1px solid var(--border-color); 
                                        color: var(--text-secondary);
                                        padding: 4px 8px; 
                                        border-radius: 4px; 
                                        cursor: pointer; 
                                        font-size: 0.75em;
                                        display: flex;
                                        align-items: center;
                                        gap: 2px;
                                        transition: all 0.2s;
                                    " onmouseover="this.style.background='var(--primary)'; this.style.color='white'; this.style.borderColor='var(--primary)'" 
                                       onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)'; this.style.borderColor='var(--border-color)'">
                                        <i class="material-icons" style="font-size: 10px;">download</i>
                                        <span>Export</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Player Chips Area (V4-network style) - Always visible -->
                            <div class="player-chips-area" id="${panel}-player-chips-area">
                                <div class="player-chips-scroll">
                                    <div class="player-chip self">
                                        <div class="chip-avatar"></div>
                                        <span class="chip-name">You</span>
                                    </div>
                                    <!-- Dynamic player chips will be added here -->
                                </div>
                            </div>
                            
                            <div class="chat-input-area">
                                <input type="text" class="chat-input" placeholder="Type your message or command..." id="${inputId}">
                                <!-- Hidden input for supabase compatibility -->
                                <input type="hidden" id="${hiddenInputId}">
                                <button class="send-btn" onclick="sendMessageFromPanel('${panel}')" id="${panel}-send-btn">Send</button>
                            </div>
                        </div>
                    `;
                
                case 'players':
                    return `
                        <div class="player-manager">
                            <div class="player-manager-header">
                                <h4>Party Characters</h4>
                                <div class="player-manager-controls">
                                    <button class="action-btn primary small" onclick="storyTellerPlayersPanel.refreshCharacters()" title="Refresh Characters">
                                        
                                    </button>
                                    <button class="action-btn info small" onclick="showSettings()" title="Get Player URL">
                                        
                                    </button>
                                    <button class="action-btn success small" onclick="storyTellerPlayersPanel.showImportDialog()" title="Import Character">
                                        
                                    </button>
                                </div>
                            </div>
                            <div id="player-list" class="player-list">
                                <div class="player-item">
                                    <div class="player-info">
                                        <span class="player-name">Loading characters...</span>
                                        <span class="player-status offline">Please wait</span>
                                    </div>
                                </div>
                            </div>
                            <div class="player-actions">
                                <div class="connection-info">
                                    <small>Characters sync automatically from V4-network</small>
                                </div>
                            </div>
                        </div>
                    `;
                
                case 'quests':
                    return `
                        <div class="quest-tracker">
                            <h4>Active Quests</h4>
                            <div class="quest-controls">
                                <button class="action-btn primary" onclick="addQuest()">
                                    <i class="ra ra-scroll-unfurled"></i>Add Quest
                                </button>
                            </div>
                            <div id="quest-list" class="quest-list">
                                <p class="placeholder-text">No active quests</p>
                            </div>
                        </div>
                    `;
                
                case 'notes':
                    return `
                        <div class="notes-panel">
                            <div class="notes-header">
                                <h4>
                                    <i class="material-icons">note</i>
                                    Notes & Messages
                                </h4>
                                <div class="notes-controls">
                                    <button class="notes-btn new" onclick="createNewNote()" title="Create New Note">
                                        <i class="material-icons">add</i>New
                                    </button>
                                    <button class="notes-btn save" onclick="saveNotes()" title="Save Current Note (Ctrl+S)">
                                        <i class="material-icons">save</i>Save
                                    </button>
                                    <button class="notes-btn export" onclick="exportNotes()" title="Export All Notes">
                                        <i class="material-icons">download</i>Export
                                    </button>
                                    <button class="notes-btn import" onclick="importNotes()" title="Import Notes">
                                        <i class="material-icons">upload</i>Import
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tab Navigation -->
                            <div class="notes-tabs" style="
                                display: flex;
                                border-bottom: 1px solid var(--border-color, #e0e0e0);
                                margin-bottom: 15px;
                            ">
                                <button class="notes-tab active" onclick="switchNotesTab('session')" style="
                                    flex: 1;
                                    padding: 10px;
                                    border: none;
                                    background: none;
                                    cursor: pointer;
                                    border-bottom: 2px solid transparent;
                                    color: var(--text-secondary, #666);
                                    font-weight: 500;
                                ">
                                    <i class="material-icons" style="font-size: 18px; margin-right: 5px;">note</i>
                                    Session Notes
                                </button>
                                <button class="notes-tab" onclick="switchNotesTab('private')" style="
                                    flex: 1;
                                    padding: 10px;
                                    border: none;
                                    background: none;
                                    cursor: pointer;
                                    border-bottom: 2px solid transparent;
                                    color: var(--text-secondary, #666);
                                    font-weight: 500;
                                    position: relative;
                                ">
                                    <i class="material-icons" style="font-size: 18px; margin-right: 5px;">mail</i>
                                    Private Messages
                                    <span class="st-notes-count" id="st-private-messages-count" style="
                                        position: absolute;
                                        top: 5px;
                                        right: 10px;
                                        background: #007bff;
                                        color: white;
                                        padding: 2px 6px;
                                        border-radius: 10px;
                                        font-size: 0.7em;
                                        display: none;
                                    "></span>
                                </button>
                            </div>
                            
                            <!-- Session Notes Tab Content -->
                            <div id="session-notes-tab" class="notes-tab-content">
                                <div class="notes-container">
                                    <div class="notes-list-container">
                                        <div class="notes-list-header">
                                            <h5>Notes List</h5>
                                            <div class="notes-list-controls">
                                                <select id="priority-filter" onchange="window.notesManager.filterByPriority(this.value)" title="Filter by Priority">
                                                    <option value="">All Notes</option>
                                                    <option value="hot"> Hot</option>
                                                    <option value="new-idea"> New Ideas</option>
                                                    <option value="important"> Important</option>
                                                    <option value="normal"> Normal</option>
                                                </select>
                                                <button class="notes-btn" onclick="window.notesManager.searchNotes(prompt('Search notes:'))" title="Search Notes" style="padding: 4px; min-height: 24px;">
                                                    <i class="material-icons" style="font-size: 16px;">search</i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="notes-list" id="notes-list">
                                            <!-- Notes will be populated by JavaScript -->
                                        </div>
                                    </div>
                                    
                                    <div class="notes-editor-container">
                                        <div class="notes-editor-header">
                                            <input type="text" id="note-title-input" class="note-title-input" placeholder="Note title...">
                                            <div class="note-priority-controls">
                                                <button class="notes-btn priority-quick" onclick="window.notesManager.quickSetPriority('hot')" title="Mark as Hot"></button>
                                                <button class="notes-btn priority-quick" onclick="window.notesManager.quickSetPriority('new-idea')" title="Mark as New Idea"></button>
                                                <button class="notes-btn priority-quick" onclick="window.notesManager.quickSetPriority('important')" title="Mark as Important"></button>
                                            </div>
                                        </div>
                                        
                                        <div class="editor-toolbar">
                                            <button class="toolbar-btn" onclick="formatSelectedText('bold')" title="Bold">
                                                <i class="material-icons">format_bold</i>
                                            </button>
                                            <button class="toolbar-btn" onclick="formatSelectedText('italic')" title="Italic">
                                                <i class="material-icons">format_italic</i>
                                            </button>
                                            <button class="toolbar-btn" onclick="formatSelectedText('highlight')" title="Highlight">
                                                <i class="material-icons">highlight</i>
                                            </button>
                                            <button class="toolbar-btn" onclick="formatSelectedText('strikethrough')" title="Strikethrough">
                                                <i class="material-icons">strikethrough_s</i>
                                            </button>
                                            <div class="toolbar-separator"></div>
                                            <button class="toolbar-btn" onclick="formatSelectedText('heading')" title="Heading">
                                                <i class="material-icons">title</i>
                                            </button>
                                            <button class="toolbar-btn" onclick="formatSelectedText('bullet')" title="Bullet List">
                                                <i class="material-icons">format_list_bulleted</i>
                                            </button>
                                            <button class="toolbar-btn" onclick="formatSelectedText('number')" title="Numbered List">
                                                <i class="material-icons">format_list_numbered</i>
                                            </button>
                                            <div class="toolbar-separator"></div>
                                            <button class="toolbar-btn" id="markdown-view-toggle" onclick="toggleMarkdownView()" title="Toggle Markdown Preview">
                                                <i class="material-icons">visibility</i>
                                            </button>
                                        </div>
                                        
                                        <div class="editor-content">
                                            <textarea id="session-notes" class="session-notes" placeholder="Select a note to start editing, or create a new one"></textarea>
                                            <div id="markdown-preview" class="markdown-preview" style="display: none;"></div>
                                        </div>
                                        
                                        <div class="notes-stats" id="notes-stats">
                                            <div class="notes-stats-item">
                                                <i class="material-icons">info</i>
                                                <span>No note selected</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Private Messages Tab Content -->
                            <div id="private-messages-tab" class="notes-tab-content" style="display: none;">
                                <div id="st-private-messages-container" class="st-private-messages-container">
                                    <div style="text-align: center; color: #8a8a8a; padding: 20px;">
                                        <i class="material-icons" style="font-size: 2em; margin-bottom: 10px; display: block;">mail_outline</i>
                                        No private messages yet! Players can send private notes via player chip clicks.
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                
                case 'dice':
                    return `
                        <div class="dice-roller">
                            <!-- Dice Mode Toggle -->
                            <div class="dice-mode-toggle">
                                <button class="dice-mode-btn active" data-mode="roll" onclick="toggleDiceMode('roll')">
                                     Roll Mode
                                </button>
                                <button class="dice-mode-btn" data-mode="build" onclick="toggleDiceMode('build')">
                                     Build Mode
                                </button>
                            </div>
                            
                            <!-- Standard D&D Dice (Always Visible) -->
                            <div class="dice-controls">
                                <button class="dice-btn" onclick="rollSimpleDie('d4')" title="d4">d4</button>
                                <button class="dice-btn" onclick="rollSimpleDie('d6')" title="d6">d6</button>
                                <button class="dice-btn" onclick="rollSimpleDie('d8')" title="d8">d8</button>
                                <button class="dice-btn" onclick="rollSimpleDie('d10')" title="d10">d10</button>
                                <button class="dice-btn" onclick="rollSimpleDie('d12')" title="d12">d12</button>
                                <button class="dice-btn" onclick="rollSimpleDie('d20')" title="d20">d20</button>
                                <button class="dice-btn" onclick="rollSimpleDie('d100')" title="d100">d100</button>
                            </div>
                            
                            <!-- Unified Roll Builder (shown in build mode) -->
                            <div class="dice-builder">
                                <div class="builder-area">
                                    <h5>Roll Builder</h5>
                                    <!-- Unified input - editable for typing OR clicking dice -->
                                    <div class="unified-roll-input">
                                        <input type="text" 
                                               id="unified-roll-input" 
                                               class="roll-input" 
                                               placeholder="Click dice above OR type: 2d6+3, 1d20+5, etc..."
                                               onkeypress="if(event.key==='Enter') rollUnifiedFormula()">
                                        <div class="roll-controls">
                                            <button class="roll-btn" onclick="rollUnifiedFormula()">
                                                <i class="material-icons">casino</i>Roll
                                            </button>
                                            <button class="roll-btn" onclick="saveUnifiedRoll()" title="Save this roll">
                                                <i class="material-icons">bookmark_add</i>Save
                                            </button>
                                            <button class="roll-btn clear" onclick="clearUnifiedBuilder()">
                                                Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advantage/Disadvantage (Always Visible) -->
                            <div class="advantage-controls">
                                <button id="advantage-btn" class="advantage-btn" onclick="setAdvantageMode('advantage')">
                                    <i class="material-icons">trending_up</i>Advantage
                                </button>
                                <button id="disadvantage-btn" class="disadvantage-btn" onclick="setAdvantageMode('disadvantage')">
                                    <i class="material-icons">trending_down</i>Disadvantage
                                </button>
                            </div>
                            
                            <!-- Saved Rolls -->
                            <div class="saved-rolls-section">
                                <div class="saved-rolls-header">
                                    <h5>Saved Rolls</h5>
                                    <div class="saved-rolls-controls">
                                        <button class="delete-mode-btn" onclick="toggleDeleteMode()"> Delete</button>
                                        <button class="saved-roll-btn" onclick="exportDiceRolls()" title="Export Rolls">
                                            <i class="material-icons">download</i>
                                        </button>
                                        <button class="saved-roll-btn" onclick="importDiceRolls()" title="Import Rolls">
                                            <i class="material-icons">upload</i>
                                        </button>
                                    </div>
                                </div>
                                <div id="saved-rolls-list" class="saved-rolls-list">
                                    <!-- Saved rolls will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Roll Results and History -->
                            <div class="roll-history-header">
                                <h5>Roll Results</h5>
                                <button class="clear-history-btn" onclick="clearRollHistory()" title="Clear History">
                                    <i class="material-icons">clear_all</i>Clear
                                </button>
                            </div>
                            <div id="dice-results" class="dice-results">
                                <p class="placeholder-text">Click a die to roll</p>
                            </div>
                        </div>
                    `;
                
                default:
                    return `<p>Content for ${content} panel coming soon...</p>`;
            }
        }

        function selectPlayer(playerName) {
            selectedPlayer = playerName;
            
            // Update UI
            document.querySelectorAll('.player-item').forEach(el => {
                el.classList.remove('selected');
            });
            if (event && event.target) {
                event.target.closest('.player-item').classList.add('selected');
            }
            
            // Open private note modal for this player
            if (window.chatImageSystem && window.chatImageSystem.openPrivateNoteModal) {
                window.chatImageSystem.openPrivateNoteModal(playerName);
            } else {
                addChatMessage(`Selected player: ${playerName}`, 'system');
            }
        }

        function selectPlayerForCommands(playerName, chipElement) {
            console.log(' selectPlayerForCommands called for:', playerName);
            selectedPlayer = playerName;
            
            // Update UI - remove selection from all chips
            document.querySelectorAll('.player-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            
            // Add selection to clicked chip
            if (chipElement) {
                chipElement.classList.add('selected');
                console.log(' Added selected class to chip for:', playerName);
            }
            
            // Update the command panel indicator
            const selectedPlayerDisplay = document.getElementById('selected-player-display');
            if (selectedPlayerDisplay) {
                selectedPlayerDisplay.innerHTML = `<span class="selected-player-name">${playerName}</span>`;
                console.log(' Updated selected player display to:', playerName);
            }
            
            // Show confirmation message
            addChatMessage(` Selected ${playerName} for commands`, 'system');
        }

        function executeCommand(command, parameter = '') {
            // Clean commands don't require a player selection
            if (command !== 'clean' && !selectedPlayer) {
                // Try to get selected player from chips
                const selectedChip = document.querySelector('.player-chip.selected');
                if (selectedChip) {
                    const chipName = selectedChip.querySelector('.chip-name');
                    selectedPlayer = chipName ? chipName.textContent : null;
                } else {
                    addChatMessage('Please select a player first by clicking on their chip!', 'system');
                    return;
                }
            }
            
            let commandText = '';
            let emoji = '';
            
            switch(command) {
                case 'loot':
                    commandText = `LOOT:${selectedPlayer}:${parameter}`;
                    emoji = '';
                    break;
                case 'levelup':
                    commandText = `LEVELUP:${selectedPlayer}`;
                    emoji = '';
                    break;
                case 'achievement':
                    commandText = `ACHIEVEMENT:${selectedPlayer}:creative_killer`;
                    emoji = '';
                    break;
                case 'heal':
                    commandText = `HEALTH:${selectedPlayer}:15`;
                    emoji = '';
                    break;
                case 'damage':
                    commandText = `HEALTH:${selectedPlayer}:-10`;
                    emoji = '';
                    break;
                case 'murder_hobo':
                    commandText = `ACHIEVEMENT:${selectedPlayer}:murder_hobo`;
                    emoji = '';
                    break;
                case 'skill_train':
                    commandText = `SKILL:${selectedPlayer}:Powerful Strike:100`;
                    emoji = '';
                    break;
                case 'experience':
                    commandText = `EXP:${selectedPlayer}:50`;
                    emoji = '';
                    break;
                case 'stat_boost':
                    commandText = `STAT:${selectedPlayer}:strength:1`;
                    emoji = '';
                    break;
                case 'heroic_deed':
                    commandText = `ACHIEVEMENT:${selectedPlayer}:heroic_deed`;
                    emoji = '';
                    break;
                case 'note':
                    // Open note dialog for selected player - doesn't send a chat command
                    if (selectedPlayer && typeof showNoteInput === 'function') {
                        showNoteInput(selectedPlayer);
                    } else {
                        addChatMessage('Please select a player first!', 'system');
                    }
                    return; // Don't send a chat command
                case 'commandlist':
                    // Show list of all available commands - doesn't need a player
                    showCommandList();
                    return; // Don't send a chat command
                case 'clean':
                    // Special handling for clean commands - doesn't need a player
                    if (parameter === 'old') {
                        commandText = `CLEAN:session:old`;
                        emoji = '';
                    } else if (parameter === 'all') {
                        // Add confirmation for dangerous operation
                        if (confirm(' This will DELETE ALL messages in the current session! Are you sure?')) {
                            commandText = `CLEAN:session:all`;
                            emoji = '';
                        } else {
                            return; // User cancelled
                        }
                    } else {
                        commandText = `CLEAN:session:old`; // Default to safe option
                        emoji = '';
                    }
                    break;
                default:
                    commandText = `${command.toUpperCase()}:${selectedPlayer}`;
                    emoji = '';
            }
            
            // Send command through the chat system (if connected)
            if (typeof sendChatMessageAsync === 'function') {
                try {
                    sendChatMessageAsync(commandText);
                    console.log(` Command Center executed: ${commandText}`);
                } catch (error) {
                    console.error('Command execution error:', error);
                    addChatMessage(` Command failed: ${error.message}`, 'system');
                }
            } else {
                // Fallback if chat system not ready
                addChatMessage(` Chat system not connected. Command would be: ${commandText}`, 'system');
            }
        }

        // Show a list of all available commands in the chat
        function showCommandList() {
            const commandsList = `
 **STORYTELLER COMMANDS** 

** LOOT & REWARDS**
 LOOT:PlayerName:handful_gold - Give gold to player
 LOOT:PlayerName:treasure_chest - Give treasure to player  
 LOOT:PlayerName:magic_item - Give magic item to player
 LOOT:PlayerName:weapon - Give weapon to player

** CHARACTER GROWTH**
 LEVELUP:PlayerName - Level up player
 ACHIEVEMENT:PlayerName:creative_killer - Give achievement
 SKILL:PlayerName:SkillName:Points - Train skill
 EXP:PlayerName:Amount - Give experience points

** HEALTH & STATUS**
 HEALTH:PlayerName:Amount - Heal (+) or damage (-) player
 STAT:PlayerName:StatName:Amount - Boost player stat
 CONDITION:PlayerName:Effect - Apply condition/effect

** QUICK ACTIONS**
 REST:PlayerName - Player takes a rest
 ACHIEVEMENT:PlayerName:murder_hobo - Murder hobo achievement
 ACHIEVEMENT:PlayerName:heroic_deed - Heroic deed achievement
 CATASTROPHE:PlayerName - Something catastrophic happens

** CHAT COMMANDS**
 DLCHAR:PlayerName:URL - Download character from GitHub
 AVATARURL:PlayerName:URL - Set player avatar
 NOTE:PlayerName:Message - Send private note

** MANAGEMENT**
 CLEAN:session:old - Remove old messages (7+ days)
 CLEAN:session:all - Remove ALL messages ( Dangerous!)

** TIP:** Select a player by clicking their chip, then use command buttons above!
            `.trim();
            
            addChatMessage(commandsList, 'system', 'System', true); // Skip emoji processing
        }

        // Helper function to get the active chat messages container
        function getActiveChatMessages() {
            // Try left panel first (dynamic)
            const leftChat = document.getElementById('left-chat-messages');
            if (leftChat && leftChat.offsetParent !== null) {
                return leftChat;
            }
            
            // Fallback to right panel (static)
            const rightChat = document.getElementById('right-chat-messages');
            if (rightChat && rightChat.offsetParent !== null) {
                return rightChat;
            }
            
            // If no panel-specific chat found, return null
            return null;
        }

        // Helper function to get the active chat input
        function getActiveChatInput() {
            // Check if user recently focused on an input
            const leftInput = document.getElementById('left-chat-input');
            const rightInput = document.getElementById('right-chat-input');
            
            // If one input is focused, return it
            if (leftInput && leftInput === document.activeElement) {
                return leftInput;
            }
            if (rightInput && rightInput === document.activeElement) {
                return rightInput;
            }
            
            // Try left panel first (if visible)
            if (leftInput && leftInput.offsetParent !== null) {
                return leftInput;
            }
            
            // Try right panel (if visible)
            if (rightInput && rightInput.offsetParent !== null) {
                return rightInput;
            }
            
            // If no panel-specific inputs found, return null
            return null;
        }

        // Helper function to add message to all visible chat panels
        function addMessageToAllChats(messageEl) {
            const panels = ['left-chat-messages', 'right-chat-messages'];
            let addedToAny = false;
            
            panels.forEach(panelId => {
                const chatMessages = document.getElementById(panelId);
                if (chatMessages) {
                    const clonedMessage = messageEl.cloneNode(true);
                    chatMessages.appendChild(clonedMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    addedToAny = true;
                }
            });
            
            // No fallback needed since dynamic panels handle all cases
            if (!addedToAny) {
                console.debug('No chat panels found to display message element (panels may not be ready yet)');
            }
        }

        // Setup chat functionality for a specific panel
        function setupChatPanel(panelSide) {
            const inputId = `${panelSide}-chat-input`;
            const sendBtnId = `${panelSide}-send-btn`;
            
            // Get the input element
            const input = document.getElementById(inputId);
            if (!input) {
                console.warn(`Chat input not found for panel: ${panelSide}`);
                return;
            }
            
            // Remove any existing event listeners by cloning the element
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);
            
            // Add Enter key listener
            newInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessageFromPanel(panelSide);
                }
            });
            
            // Also add support for touch devices
            newInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && e.target.value.trim()) {
                    e.preventDefault();
                    sendMessageFromPanel(panelSide);
                }
            });
            
            console.log(` Chat panel setup complete for: ${panelSide}`);
        }

        // Send message from a specific panel
        async function sendMessageFromPanel(panelSide) {
            const inputId = `${panelSide}-chat-input`;
            const input = document.getElementById(inputId);
            
            if (!input) {
                console.warn(`Chat input not found for panel: ${panelSide}`);
                return;
            }
            
            let message = input.value.trim();
            
            if (!message) return;
            
            // Check if we have an active session
            if (!window.currentGameSession) {
                addChatMessage(' No active session. Please start a session first.', 'system');
                return;
            }
            
            try {
                // Send via Supabase real-time system ONLY - don't add locally
                if (window.sendChatMessageAsync && typeof window.sendChatMessageAsync === 'function') {
                    await window.sendChatMessageAsync(message);
                    console.log(` Message sent from ${panelSide} via Supabase real-time - waiting for echo`);
                    
                    // Clear input only after successful send
                    input.value = '';
                    
                } else if (window.sendChatMessage && typeof window.sendChatMessage === 'function') {
                    // Fallback to sync method
                    window.sendChatMessage(message);
                    input.value = '';
                    console.log(` Message sent from ${panelSide} via Supabase sync - waiting for echo`);
                } else {
                    // Local fallback
                    addChatMessage(message, 'storyteller');
                    input.value = '';
                    console.log(` Message added locally from ${panelSide} (no Supabase)`);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addChatMessage(` Error sending message: ${error.message}`, 'system');
            }
        }

        // Emoji picker functionality
        function showChatPicker(panelSide) {
            if (!window.emojiProcessor || !window.chatEffectsManager) {
                console.warn('Chat picker dependencies not loaded');
                return;
            }
            
            const emoticonList = window.emojiProcessor.getEmoticonList();
            const effectsData = window.chatEffectsManager.effects;
            const inputId = `${panelSide}-chat-input`;
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            // Create picker content
            const picker = document.createElement('div');
            picker.style.cssText = `
                background: var(--bg-primary);
                border-radius: 8px;
                padding: 20px;
                max-width: 700px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                position: relative;
            `;
            
            let pickerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: var(--text-primary);"> Enhanced Chat Picker</h4>
                    <button onclick="this.closest('.chat-picker-modal').remove()" 
                            style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary);"
                            title="Close"></button>
                </div>
                
                <!-- Tab Navigation -->
                <div style="display: flex; margin-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                    <button onclick="switchPickerTab('emojis')" id="tab-emojis" class="picker-tab active" 
                            style="flex: 1; padding: 8px 16px; background: none; border: none; cursor: pointer; color: var(--accent-color); border-bottom: 2px solid var(--accent-color);">
                         Emojis
                    </button>
                    <button onclick="switchPickerTab('effects')" id="tab-effects" class="picker-tab"
                            style="flex: 1; padding: 8px 16px; background: none; border: none; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent;">
                         Effects
                    </button>
                    <button onclick="switchPickerTab('combinations')" id="tab-combinations" class="picker-tab"
                            style="flex: 1; padding: 8px 16px; background: none; border: none; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent;">
                         Combos
                    </button>
                </div>
                
                <!-- Content Area -->
                <div id="picker-content" style="min-height: 300px;">
            `;
            
            // EMOJI TAB CONTENT
            pickerHTML += '<div id="emojis-content" class="tab-content">';
            Object.keys(emoticonList).forEach(category => {
                const cat = emoticonList[category];
                pickerHTML += `<div style="margin-bottom: 16px;">`;
                pickerHTML += `<h5 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; font-weight: 600;">${cat.name}</h5>`;
                pickerHTML += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">`;
                
                cat.emojis.forEach(emoji => {
                    pickerHTML += `
                        <button onclick="insertText('${inputId}', '${emoji.code}')" 
                                style="
                                    background: var(--bg-secondary);
                                    border: 1px solid var(--border-color);
                                    border-radius: 6px;
                                    padding: 8px;
                                    cursor: pointer;
                                    font-size: 0.8em;
                                    transition: all 0.2s;
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                    color: var(--text-primary);
                                    text-align: left;
                                "
                                onmouseover="this.style.background='var(--accent-color)'; this.style.color='white'; this.style.transform='translateY(-1px)';"
                                onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'; this.style.transform='translateY(0)';"
                                title="${emoji.name}">
                            <span style="font-size: 1.2em;">${emoji.emoji}</span>
                            <span style="font-size: 0.75em; opacity: 0.8;">${emoji.code}</span>
                        </button>
                    `;
                });
                pickerHTML += `</div></div>`;
            });
            pickerHTML += '</div>';
            
            // EFFECTS TAB CONTENT
            pickerHTML += '<div id="effects-content" class="tab-content" style="display: none;">';
            
            if (effectsData && effectsData.effects) {
                // Basic effects
                if (effectsData.effects.basic) {
                    pickerHTML += `<div style="margin-bottom: 16px;">`;
                    pickerHTML += `<h5 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; font-weight: 600;"> Basic Effects</h5>`;
                    pickerHTML += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 6px;">`;
                    
                    Object.keys(effectsData.effects.basic).forEach(key => {
                        const effect = effectsData.effects.basic[key];
                        pickerHTML += `
                            <button onclick="insertText('${inputId}', '${effect.command}')" 
                                    style="
                                        background: var(--bg-secondary);
                                        border: 1px solid var(--border-color);
                                        border-radius: 6px;
                                        padding: 8px;
                                        cursor: pointer;
                                        font-size: 0.8em;
                                        transition: all 0.2s;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: flex-start;
                                        gap: 4px;
                                        color: var(--text-primary);
                                        text-align: left;
                                    "
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white'; this.style.transform='translateY(-1px)';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'; this.style.transform='translateY(0)';"
                                    title="${effect.description}">
                                <span style="font-weight: bold; font-size: 0.85em;">${effect.name}</span>
                                <span style="font-size: 0.7em; opacity: 0.8; color: var(--accent-color);">${effect.command}</span>
                                <span style="font-size: 0.65em; opacity: 0.6; line-height: 1.2;">${effect.description}</span>
                            </button>
                        `;
                    });
                    pickerHTML += `</div></div>`;
                }
                
                // Gaming effects
                if (effectsData.effects.gaming) {
                    pickerHTML += `<div style="margin-bottom: 16px;">`;
                    pickerHTML += `<h5 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; font-weight: 600;"> Gaming Effects</h5>`;
                    pickerHTML += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 6px;">`;
                    
                    Object.keys(effectsData.effects.gaming).forEach(key => {
                        const effect = effectsData.effects.gaming[key];
                        pickerHTML += `
                            <button onclick="insertText('${inputId}', '${effect.command}')" 
                                    style="
                                        background: var(--bg-secondary);
                                        border: 1px solid var(--border-color);
                                        border-radius: 6px;
                                        padding: 8px;
                                        cursor: pointer;
                                        font-size: 0.8em;
                                        transition: all 0.2s;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: flex-start;
                                        gap: 4px;
                                        color: var(--text-primary);
                                        text-align: left;
                                    "
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white'; this.style.transform='translateY(-1px)';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'; this.style.transform='translateY(0)';"
                                    title="${effect.description}">
                                <span style="font-weight: bold; font-size: 0.85em;">${effect.name}</span>
                                <span style="font-size: 0.7em; opacity: 0.8; color: var(--accent-color);">${effect.command}</span>
                                <span style="font-size: 0.65em; opacity: 0.6; line-height: 1.2;">${effect.description}</span>
                            </button>
                        `;
                    });
                    pickerHTML += `</div></div>`;
                }
                
                // Emotional effects
                if (effectsData.effects.emotional) {
                    pickerHTML += `<div style="margin-bottom: 16px;">`;
                    pickerHTML += `<h5 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; font-weight: 600;"> Emotional Effects</h5>`;
                    pickerHTML += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 6px;">`;
                    
                    Object.keys(effectsData.effects.emotional).forEach(key => {
                        const effect = effectsData.effects.emotional[key];
                        pickerHTML += `
                            <button onclick="insertText('${inputId}', '${effect.command}')" 
                                    style="
                                        background: var(--bg-secondary);
                                        border: 1px solid var(--border-color);
                                        border-radius: 6px;
                                        padding: 8px;
                                        cursor: pointer;
                                        font-size: 0.8em;
                                        transition: all 0.2s;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: flex-start;
                                        gap: 4px;
                                        color: var(--text-primary);
                                        text-align: left;
                                    "
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white'; this.style.transform='translateY(-1px)';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'; this.style.transform='translateY(0)';"
                                    title="${effect.description}">
                                <span style="font-weight: bold; font-size: 0.85em;">${effect.name}</span>
                                <span style="font-size: 0.7em; opacity: 0.8; color: var(--accent-color);">${effect.command}</span>
                                <span style="font-size: 0.65em; opacity: 0.6; line-height: 1.2;">${effect.description}</span>
                            </button>
                        `;
                    });
                    pickerHTML += `</div></div>`;
                }
                
                // Modifiers
                if (effectsData.effects.modifiers) {
                    pickerHTML += `<div style="margin-bottom: 16px;">`;
                    pickerHTML += `<h5 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; font-weight: 600;"> Modifiers</h5>`;
                    pickerHTML += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">`;
                    
                    Object.keys(effectsData.effects.modifiers).forEach(key => {
                        const effect = effectsData.effects.modifiers[key];
                        pickerHTML += `
                            <button onclick="insertText('${inputId}', '${effect.command}')" 
                                    style="
                                        background: var(--bg-secondary);
                                        border: 1px solid var(--border-color);
                                        border-radius: 6px;
                                        padding: 8px;
                                        cursor: pointer;
                                        font-size: 0.8em;
                                        transition: all 0.2s;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: flex-start;
                                        gap: 4px;
                                        color: var(--text-primary);
                                        text-align: left;
                                    "
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white'; this.style.transform='translateY(-1px)';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'; this.style.transform='translateY(0)';"
                                    title="${effect.description}">
                                <span style="font-weight: bold; font-size: 0.85em;">${effect.name}</span>
                                <span style="font-size: 0.7em; opacity: 0.8; color: var(--accent-color);">${effect.command}</span>
                                <span style="font-size: 0.65em; opacity: 0.6; line-height: 1.2;">${effect.description}</span>
                            </button>
                        `;
                    });
                    pickerHTML += `</div></div>`;
                }
            }
            pickerHTML += '</div>';
            
            // COMBINATIONS TAB CONTENT
            pickerHTML += `
                <div id="combinations-content" class="tab-content" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <h5 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; font-weight: 600;"> Popular Combinations</h5>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="insertText('${inputId}', ':crit: :big: ')" 
                                    style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; cursor: pointer; text-align: left; transition: all 0.2s;"
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)';">
                                <strong>:crit: :big:</strong> - Big Critical Hit Effect
                            </button>
                            <button onclick="insertText('${inputId}', ':sparkle: :slow: ')" 
                                    style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; cursor: pointer; text-align: left; transition: all 0.2s;"
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)';">
                                <strong>:sparkle: :slow:</strong> - Slow Magic Sparkle
                            </button>
                            <button onclick="insertText('${inputId}', ':fire: :throb: ')" 
                                    style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; cursor: pointer; text-align: left; transition: all 0.2s;"
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)';">
                                <strong>:fire: :throb:</strong> - Throbbing Fire Effect
                            </button>
                            <button onclick="insertText('${inputId}', ':divine: :glow: ')" 
                                    style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; cursor: pointer; text-align: left; transition: all 0.2s;"
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)';">
                                <strong>:divine: :glow:</strong> - Divine Glow
                            </button>
                            <button onclick="insertText('${inputId}', ':bounce: :fast: ')" 
                                    style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; cursor: pointer; text-align: left; transition: all 0.2s;"
                                    onmouseover="this.style.background='var(--accent-color)'; this.style.color='white';"
                                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)';">
                                <strong>:bounce: :fast:</strong> - Quick Bounce
                            </button>
                        </div>
                    </div>
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 6px; color: var(--text-tertiary); font-size: 0.8em; line-height: 1.4;">
                        <strong> Pro Tips:</strong><br>
                         Effects apply to text that follows them<br>
                         Combine multiple effects for unique results<br>
                         Use modifiers like :fast: :slow: :big: to customize<br>
                         Mix with emojis for enhanced visual impact<br>
                         Example: ":lightning: :big:  THUNDER STRIKE! "
                    </div>
                </div>
            `;
            
            pickerHTML += `
                </div>
            `;
            
            picker.innerHTML = pickerHTML;
            modal.className = 'chat-picker-modal';
            modal.appendChild(picker);
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Tab switching function
        function switchPickerTab(tabName) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Reset all tabs
            document.querySelectorAll('.picker-tab').forEach(tab => {
                tab.style.color = 'var(--text-secondary)';
                tab.style.borderBottomColor = 'transparent';
            });
            
            // Show selected content
            document.getElementById(tabName + '-content').style.display = 'block';
            
            // Highlight selected tab
            const selectedTab = document.getElementById('tab-' + tabName);
            selectedTab.style.color = 'var(--accent-color)';
            selectedTab.style.borderBottomColor = 'var(--accent-color)';
        }

        // Unified function for inserting text (emojis and effects)
        function insertText(inputId, text) {
            const input = document.getElementById(inputId);
            if (input) {
                const cursorPos = input.selectionStart;
                const textBefore = input.value.substring(0, cursorPos);
                const textAfter = input.value.substring(input.selectionEnd);
                
                input.value = textBefore + text + ' ' + textAfter;
                input.setSelectionRange(cursorPos + text.length + 1, cursorPos + text.length + 1);
                input.focus();
                
                // Close the modal
                document.querySelector('.chat-picker-modal')?.remove();
            }
        }

        // Legacy function for backwards compatibility - now redirects to unified picker
        function showEmojiPicker(panelSide) {
            showChatPicker(panelSide);
        }

        // Legacy function for backwards compatibility - now redirects to unified picker
        function showEffectsPicker(panelSide) {
            showChatPicker(panelSide);
        }

        // Remove old insert functions
        function insertEmoji(inputId, emojiCode) {
            insertText(inputId, emojiCode);
        }
        
        function insertEffect(inputId, effectCommand) {
            insertText(inputId, effectCommand);
        }

        function addChatMessage(message, type = 'storyteller', playerName = 'Storyteller', skipEmojiProcessing = false) {
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${type}`;
            
            console.log(' addChatMessage called with:', { message, type, playerName, skipEmojiProcessing });
            console.log(' chatEffectsManager available:', !!window.chatEffectsManager);
            
            // Process message for emojis first (unless explicitly skipped)
            let processedMessage = message;
            if (!skipEmojiProcessing && window.emojiProcessor) {
                processedMessage = window.emojiProcessor.processMessage(processedMessage);
                if (processedMessage !== message) {
                    console.log(` Emoji converted: "${message}"  "${processedMessage}"`);
                }
            } else if (skipEmojiProcessing) {
                console.log(' Skipping emoji processing as requested');
            }
            
            // Then process message for chat effects
            let hasEffects = false;
            
            if (window.chatEffectsManager) {
                console.log(' Processing message for effects:', processedMessage);
                const effectResult = window.chatEffectsManager.processMessage(processedMessage);
                console.log(' Effect result:', effectResult);
                if (effectResult.hasEffects) {
                    processedMessage = effectResult.html;
                    hasEffects = true;
                    console.log(' Applied chat effects to message:', effectResult.effects);
                }
            } else {
                console.log(' chatEffectsManager not available');
            }
            
            // Parse player name for accent color (format: "playername|#hexcolor")
            let playerDisplayName = playerName;
            let playerColor = '';
            
            if (playerDisplayName.includes('|')) {
                const parts = playerDisplayName.split('|');
                playerDisplayName = parts[0];
                playerColor = parts[1];
                
                // Validate hex color format
                if (playerColor && !playerColor.match(/^#[0-9A-Fa-f]{6}$/)) {
                    playerColor = ''; // Invalid color, use default
                }
            }
            
            // Apply color styling if valid color provided
            const colorStyle = playerColor ? `style="color: ${playerColor}; font-weight: bold;"` : '';
            
            if (type === 'system') {
                messageEl.innerHTML = `<strong>System:</strong> ${processedMessage}`;
            } else if (type === 'player') {
                messageEl.innerHTML = `<strong ${colorStyle}>${playerDisplayName}:</strong> ${processedMessage}`;
            } else {
                messageEl.innerHTML = `<strong ${colorStyle}>${playerDisplayName}:</strong> ${processedMessage}`;
            }
            
            // Add to all visible chat panels
            addMessageToAllChats(messageEl);
            
            // Debounced reset for rapid message additions
            clearTimeout(window.chatResetTimeout);
            window.chatResetTimeout = setTimeout(() => {
                resetChatContainer();
            }, 500); // Reset after 500ms of no new messages
        }

        // Reset chat container dimensions after dynamic content changes
        function resetChatContainer() {
            const chatMessages = getActiveChatMessages();
            if (chatMessages) {
                // Force recalculation of container dimensions
                chatMessages.style.height = '';
                chatMessages.style.minHeight = '';
                
                // Use requestAnimationFrame to ensure DOM updates are complete
                requestAnimationFrame(() => {
                    chatMessages.style.height = '100%';
                    chatMessages.style.minHeight = '0';
                    
                    // Scroll to bottom after reset
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    console.log(' Chat container dimensions reset');
                });
            }
        }

        // Enhanced sendMessage function using real-time chat
        async function sendMessage() {
            const input = getActiveChatInput();
            if (!input) {
                console.warn('No active chat input found');
                return;
            }

            let message = input.value.trim();

            if (!message) return;

            // Check if we have an active session
            if (!window.currentGameSession) {
                addChatMessage(' No active session. Please start a session first.', 'system');
                return;
            }

            try {
                // Send via Supabase real-time system ONLY - don't add locally
                if (window.sendChatMessageAsync && typeof window.sendChatMessageAsync === 'function') {
                    await window.sendChatMessageAsync(message);
                    console.log(' Message sent via Supabase real-time - waiting for echo');
                    
                    // Clear input only after successful send
                    input.value = '';
                    
                } else if (window.sendChatMessage && typeof window.sendChatMessage === 'function') {
                    // Fallback to sync method
                    window.sendChatMessage(message);
                    input.value = '';
                    console.log(' Message sent via Supabase sync - waiting for echo');
                    
                } else {
                    // No Supabase connection available
                    addChatMessage(' Real-time chat not available. Please check Supabase connection.', 'system');
                }
                
            } catch (error) {
                console.error(' Message send error:', error);
                addChatMessage(` Failed to send message: ${error.message}`, 'system');
            }
        }
        
        // Function to update connected players list (copied from V4-network)
        function updateConnectedPlayers(players = []) {
            console.log(' Updating connected players:', players);
            console.log(' ChatCommandParser available:', !!window.chatCommandParser);
            
            // Update player chips in chat interface
            const playerChipsScroll = document.querySelector('.player-chips-scroll');
            if (playerChipsScroll) {
                // Update the self chip with current player info and avatar
                let selfChip = playerChipsScroll.querySelector('.player-chip.self');
                if (selfChip) {
                    // Update self chip with current player name and avatar
                    const currentPlayerName = window.currentPlayerName || 'You';
                    const nameElement = selfChip.querySelector('.chip-name');
                    if (nameElement) {
                        nameElement.textContent = currentPlayerName;
                    }
                    
                    // Check if we have an avatar for the current player
                    const avatarElement = selfChip.querySelector('.chip-avatar');
                    if (avatarElement) {
                        const chatParser = window.chatCommandParser;
                        const cachedAvatarUrl = chatParser?.getCachedAvatarUrl?.(currentPlayerName);
                        
                        if (cachedAvatarUrl) {
                            avatarElement.innerHTML = `<img src="${cachedAvatarUrl}" alt="${currentPlayerName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML=''">`;
                        } else {
                            // Try to get avatar from current character data
                            const characterData = getCurrentCharacterData();
                            if (characterData?.personal?.avatarUrl) {
                                avatarElement.innerHTML = `<img src="${characterData.personal.avatarUrl}" alt="${currentPlayerName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML=''">`;
                                
                                // Cache it for future use
                                if (chatParser && typeof chatParser.handleAvatarUrlCommand === 'function') {
                                    chatParser.handleAvatarUrlCommand(currentPlayerName, characterData.personal.avatarUrl, 'self');
                                }
                            } else {
                                avatarElement.innerHTML = '';
                            }
                        }
                    }
                    
                    // Add click handling to self chip for command selection
                    if (!selfChip.hasAttribute('data-click-handler-added')) {
                        selfChip.addEventListener('click', (e) => {
                            console.log(' Self chip clicked');
                            
                            // Prevent any default behavior or event bubbling
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Provide haptic feedback on supported devices
                            if (navigator.vibrate) {
                                navigator.vibrate(50);
                            }
                            
                            // Visual feedback animation
                            selfChip.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                selfChip.style.transform = '';
                            }, 150);
                            
                            // Always select for commands since you can't send notes to yourself
                            const currentPlayerName = window.currentPlayerName || 'You';
                            console.log(' Calling selectPlayerForCommands for self:', currentPlayerName);
                            selectPlayerForCommands(currentPlayerName, selfChip);
                        });
                        
                        // Update title
                        selfChip.title = 'Click to select yourself for commands';
                        selfChip.style.cursor = 'pointer';
                        selfChip.setAttribute('data-click-handler-added', 'true');
                    }
                }
                
                // Clear other chips but keep self
                const allChips = Array.from(playerChipsScroll.children);
                allChips.forEach(chip => {
                    if (!chip.classList.contains('self')) {
                        chip.remove();
                    }
                });
                
                // Add player chips for connected players
                console.log(' Creating chips for connected players:', players);
                players.forEach(player => {
                    if (player.name && player.name !== window.currentPlayerName && player.name !== 'System' && player.name !== 'Heartbeat') {
                        console.log(` Creating chip for player: ${player.name}`);
                        const chipDiv = document.createElement('div');
                        chipDiv.className = 'player-chip';
                        
                        if (player.is_storyteller) {
                            chipDiv.classList.add('storyteller');
                        }
                        
                        // Check for cached avatar URL
                        let avatarContent;
                        const chatParser = window.chatCommandParser;
                        const cachedAvatarUrl = chatParser?.getCachedAvatarUrl?.(player.name);
                        
                        console.log(` Cached avatar URL for ${player.name}:`, cachedAvatarUrl);
                        
                        if (cachedAvatarUrl) {
                            avatarContent = `<img src="${cachedAvatarUrl}" alt="${player.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML='${player.is_storyteller ? '' : ''}'">`;
                            console.log(` Using cached avatar for ${player.name}`);
                        } else {
                            avatarContent = player.is_storyteller ? '' : '';
                            console.log(` No cached avatar for ${player.name}, using default: ${avatarContent}`);
                        }
                        
                        chipDiv.innerHTML = `
                            <div class="chip-avatar">${avatarContent}</div>
                            <span class="chip-name">${player.name}</span>
                        `;
                        
                        // Add click event for player interaction (selection only)
                        chipDiv.addEventListener('click', (e) => {
                            console.log(' Player chip clicked:', player.name);
                            
                            // Prevent any default behavior or event bubbling
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Provide haptic feedback on supported devices
                            if (navigator.vibrate) {
                                navigator.vibrate(50); // Short vibration
                            }
                            
                            // Visual feedback animation
                            chipDiv.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                chipDiv.style.transform = '';
                            }, 150);
                            
                            // Select player for commands (simplified behavior)
                            console.log(' Calling selectPlayerForCommands for:', player.name);
                            selectPlayerForCommands(player.name, chipDiv);
                            
                            /* COMMENTED OUT: Old dual-mode behavior
                            // Check if shift key is held for command selection mode
                            if (e.shiftKey) {
                                selectPlayerForCommands(player.name, chipDiv);
                            } else {
                                // Default behavior: send note
                                showNoteInput(player.name);
                            }
                            */
                        });
                        
                        // Add touch event handlers for better mobile experience
                        chipDiv.addEventListener('touchstart', (e) => {
                            chipDiv.style.transition = 'transform 0.1s ease';
                        });
                        
                        chipDiv.addEventListener('touchend', (e) => {
                            chipDiv.style.transition = 'all 0.2s ease';
                        });
                        
                        // Add visual feedback for clickable chips
                        chipDiv.style.cursor = 'pointer';
                        chipDiv.title = `Click to select ${player.name} for commands`;
                        
                        playerChipsScroll.appendChild(chipDiv);
                    }
                });
                
                console.log(` Player chips updated: ${players.length} players found`);
                
                // Player chips area is always visible now - no need to show/hide
            }
            
            // Update legacy player lists for panels (backup support)
            const playerListSelectors = ['#player-list', '#right-player-list', '#left-player-list'];
            const noPlayersSelectors = ['#no-players', '#right-no-players', '#left-no-players'];
            
            playerListSelectors.forEach((selector, index) => {
                const playerList = document.querySelector(selector);
                if (!playerList) return;
                
                const noPlayersDiv = document.querySelector(noPlayersSelectors[index]);
                
                // Clear existing players (except DM)
                const dmPlayerSelector = selector.replace('-player-list', '-dm-player');
                const dmPlayer = document.querySelector(dmPlayerSelector);
                playerList.innerHTML = '';
                if (dmPlayer) {
                    playerList.appendChild(dmPlayer);
                }
                
                // Add connected players
                players.forEach(player => {
                    if (player.name && player.name !== 'System' && !player.is_storyteller) {
                        const playerDiv = document.createElement('div');
                        playerDiv.className = 'player-item';
                        playerDiv.onclick = () => selectPlayer(player.name);
                        
                        playerDiv.innerHTML = `
                            <div class="player-name">${player.name}</div>
                            <div class="player-stats">Connected Player</div>
                        `;
                        
                        playerList.appendChild(playerDiv);
                    }
                });
                
                // Show/hide no players message
                const hasPlayers = players.length > 0;
                if (noPlayersDiv) {
                    noPlayersDiv.style.display = hasPlayers ? 'none' : 'block';
                }
            });
            
            console.log(` Player list updated: ${players.length} players found`);
        }
        
        // Helper function to get current character data (similar to qr.js)
        function getCurrentCharacterData() {
            // Try different ways to get current character data
            
            // First check if the global character object exists (main.js)
            if (typeof character !== 'undefined' && character) {
                return character;
            }
            
            if (window.currentCharacter) {
                return window.currentCharacter;
            }
            
            if (window.character) {
                return window.character;
            }
            
            // Try to get from character manager
            if (window.characterManager && window.characterManager.currentCharacterId && window.characterManager.characters) {
                const currentChar = characterManager.characters.find(
                    char => char.id === characterManager.currentCharacterId
                );
                if (currentChar) return currentChar;
            }
            
            return null;
        }
        
        // Modern modal-based note input for player chip clicks (copied from V4-network)
        function showNoteInput(targetPlayerName) {
            console.log(' showNoteInput called for:', targetPlayerName);
            
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 450px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: noteModalSlideIn 0.3s ease-out;
            `;
            
            // Add CSS animation if not already present
            if (!document.getElementById('note-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'note-modal-styles';
                style.textContent = `
                    @keyframes noteModalSlideIn {
                        from { opacity: 0; transform: translateY(-20px) scale(0.95); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Create modal HTML
            modal.innerHTML = `
                <h3 style="margin: 0 0 16px; color: #333; font-size: 20px;">Send Note to ${targetPlayerName}</h3>
                <textarea 
                    id="note-text" 
                    placeholder="Type your private note here..."
                    style="width: 100%; height: 120px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; box-sizing: border-box; font-family: inherit;"
                ></textarea>
                <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="note-cancel-btn" style="flex: 1; min-width: 100px; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.2s;">Cancel</button>
                    <button id="note-send-btn" style="flex: 1; min-width: 100px; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.2s;">Send Note</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus the textarea
            const textarea = modal.querySelector('#note-text');
            setTimeout(() => textarea.focus(), 100);
            
            // Handle buttons
            const cancelBtn = modal.querySelector('#note-cancel-btn');
            const sendBtn = modal.querySelector('#note-send-btn');
            
            const closeModal = () => {
                overlay.style.animation = 'noteModalSlideIn 0.2s ease-in reverse';
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 200);
            };
            
            cancelBtn.addEventListener('click', closeModal);
            
            sendBtn.addEventListener('click', () => {
                const noteText = textarea.value.trim();
                if (!noteText) {
                    alert('Please enter a note before sending.');
                    textarea.focus();
                    return;
                }
                
                // Send the note via chat system
                const message = `/note ${targetPlayerName} ${noteText}`;
                
                // Try to send through the chat system
                if (window.sendChatMessage && typeof window.sendChatMessage === 'function') {
                    window.sendChatMessage(message);
                } else if (window.sendMessage && typeof window.sendMessage === 'function') {
                    window.sendMessage(message);
                } else {
                    // Fallback: try to trigger the chat input
                    console.log('Sending note message:', message);
                    const chatInput = document.querySelector('#chat-input, .chat-input, input[type="text"]');
                    if (chatInput) {
                        chatInput.value = message;
                        // Trigger enter key event
                        const enterEvent = new KeyboardEvent('keydown', { key: 'Enter', keyCode: 13 });
                        chatInput.dispatchEvent(enterEvent);
                    } else {
                        console.warn('Could not find chat input to send note');
                        alert('Note functionality not available - chat system not found.');
                    }
                }
                
                closeModal();
            });
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeModal();
                }
            });
            
            // Close on Escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }
        
        // Make updateConnectedPlayers globally available for supabase-chat.js
        console.log(' Setting up real updateConnectedPlayers function in window');
        window.updateConnectedPlayers = updateConnectedPlayers;
        console.log(' updateConnectedPlayers is now available in window:', typeof window.updateConnectedPlayers);
        
        // Process any pending players that were stored by the temporary stub
        if (window._pendingConnectedPlayers) {
            console.log(' Processing pending connected players from stub');
            updateConnectedPlayers(window._pendingConnectedPlayers);
            delete window._pendingConnectedPlayers;
            console.log(' Processed and cleared pending players');
        }
        
        // Create a simple chatCommandParser-like object for compatibility
        if (!window.chatCommandParser) {
            window.chatCommandParser = {
                getCachedAvatarUrl: function(playerName) {
                    if (window.stPlayerAvatars && window.stPlayerAvatars.has) {
                        return window.stPlayerAvatars.get(playerName) || null;
                    }
                    return null;
                },
                handleAvatarUrlCommand: function(playerName, avatarUrl, type) {
                    if (!window.stPlayerAvatars) {
                        window.stPlayerAvatars = new Map();
                    }
                    window.stPlayerAvatars.set(playerName, avatarUrl);
                    console.log(` Cached avatar for ${playerName}:`, avatarUrl);
                }
            };
        }

        function swapPanels() {
            const temp = leftPanelContent;
            leftPanelContent = rightPanelContent;
            rightPanelContent = temp;
            
            document.getElementById('left-panel-title').textContent = getPanelTitle(leftPanelContent);
            document.getElementById('right-panel-title').textContent = getPanelTitle(rightPanelContent);
            
            addChatMessage('Panels swapped!', 'system');
        }

        function toggleSinglePanel() {
            const contentArea = document.querySelector('.content-area');
            contentArea.style.gridTemplateColumns = 
                contentArea.style.gridTemplateColumns === '1fr' ? '1fr 1fr' : '1fr';
        }

        function clearChat() {
            const panels = ['left-chat-messages', 'right-chat-messages'];
            let clearedAny = false;
            
            panels.forEach(panelId => {
                const chatMessages = document.getElementById(panelId);
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                    clearedAny = true;
                }
            });
            
            // No fallback needed since dynamic panels handle all cases
            if (!clearedAny) {
                console.warn('No chat panels found to clear');
            }
            
            addChatMessage('Chat cleared.', 'system');
        }

        function exportChat() {
            const panels = ['left-chat-messages', 'right-chat-messages'];
            let chatContent = '';
            let foundAny = false;
            
            // Find the first available chat panel
            for (const panelId of panels) {
                const chatMessages = document.getElementById(panelId);
                if (chatMessages) {
                    const messages = chatMessages.querySelectorAll('.chat-message');
                    messages.forEach(msg => {
                        chatContent += msg.textContent.trim() + '\n';
                    });
                    foundAny = true;
                    break; // Only export from one panel to avoid duplicates
                }
            }
            
            if (!foundAny) {
                addChatMessage(' No chat content to export', 'system');
                return;
            }
            
            if (!chatContent.trim()) {
                addChatMessage(' Chat is empty - nothing to export', 'system');
                return;
            }
            
            // Create and download the file
            const sessionCode = window.currentGameSession?.session_code || 'unknown';
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `dcc-chat-${sessionCode}-${timestamp}.txt`;
            
            const blob = new Blob([chatContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);
            addChatMessage(` Chat exported as: ${filename}`, 'system');
        }

        function saveSession() {
            addChatMessage('Session saved!', 'system');
        }

        function showSettings() {
            // Update player URL with proper session information
            let playerURL = 'Not available - Start a session first';
            
            // Check if we have an active game session
            if (window.currentGameSession && window.currentGameSession.session_code) {
                // Generate Supabase URL + session for players to copy/paste
                const config = loadSupabaseConfig();
                if (config && config.url) {
                    const fullUrl = `${config.url}?session=${window.currentGameSession.session_code}`;
                    // Use shortened URL for display and copying
                    const shortUrl = window.supabaseUrlEncoder ? 
                        window.supabaseUrlEncoder.encodeUrl(fullUrl) : fullUrl;
                    playerURL = shortUrl;
                } else {
                    playerURL = 'Supabase not configured - please set up Supabase settings first';
                }
            } else if (window.currentSession && window.currentSession.name !== 'New Session') {
                // Fallback to local session for testing
                playerURL = 'Local session - no Supabase URL available';
            }
            
            document.getElementById('player-url').value = playerURL;
            
            // Show modal
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function hideSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        // Chevron Section Toggle
        function toggleChevron(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        // Display Mode Management
        function setDisplayMode(mode) {
            // Remove all mode classes
            document.body.classList.remove('compact-mode', 'highres-mode', 'ultra-mode');
            
            // Add new mode class
            if (mode !== 'tablet') {
                document.body.classList.add(mode + '-mode');
            }
            
            // Update mode selector
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.mode === mode) {
                    option.classList.add('active');
                }
            });
            
            // Update device info
            const deviceInfo = document.getElementById('device-info');
            const modeNames = {
                'tablet': 'Standard Tablet Mode',
                'compact': 'Compact High-Density Mode',
                'highres': 'High Resolution Mode', 
                'ultra': 'Ultra Wide Mode'
            };
            deviceInfo.textContent = modeNames[mode] || 'Unknown Mode';
            
            // Save preference
            localStorage.setItem('storyteller-display-mode', mode);
        }

        // Initialize display mode from storage
        function initializeDisplayMode() {
            const savedMode = localStorage.getItem('storyteller-display-mode') || 'tablet';
            setDisplayMode(savedMode);
        }

        // Mode selector click handler
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize display mode
            initializeDisplayMode();
            
            // Add click handlers to mode options
            document.querySelectorAll('.mode-option').forEach(option => {
                option.addEventListener('click', function() {
                    setDisplayMode(this.dataset.mode);
                });
            });
        });

        // Supabase Setup Guide Modal
        function showSupabaseGuide() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('supabase-guide-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'supabase-guide-modal';
                modal.innerHTML = `
                    <div class="settings-modal" style="display: block;">
                        <div class="settings-modal-content" style="max-width: 800px; max-height: 80vh;">
                            <div class="settings-header">
                                <h3> Supabase Setup Guide</h3>
                                <button class="close-btn" onclick="hideSupabaseGuide()">
                                    <i class="material-icons">close</i>
                                </button>
                            </div>
                            <div class="settings-body" style="overflow-y: auto; max-height: 60vh;">
                                <div class="guide-content">
                                    <p><strong>Why use your own Supabase?</strong></p>
                                    <p>Using your own Supabase instance gives you full control over your data, better performance, and ensures your gaming sessions are private.</p>
                                    
                                    <h4>Quick Setup Steps:</h4>
                                    <ol>
                                        <li><strong>Create Account:</strong> Go to <a href="https://supabase.com" target="_blank" style="color: #4CAF50;">supabase.com</a> and sign up</li>
                                        <li><strong>New Project:</strong> Create a new project in your dashboard</li>
                                        <li><strong>Get URL & Key:</strong> Find your Project URL and anon/public API key in Settings > API</li>
                                        <li><strong>Setup Tables:</strong> Use the SQL editor to create required tables</li>
                                    </ol>
                                    
                                    <div style="background: #2a2a2a; padding: 15px; border-radius: 5px; margin: 15px 0;">
                                        <h4>Required SQL Tables:</h4>
                                        <pre style="color: #4CAF50; font-size: 0.9em; overflow-x: auto;">
-- Game Sessions Table
CREATE TABLE game_sessions (
  id SERIAL PRIMARY KEY,
  session_code VARCHAR(20) UNIQUE NOT NULL,
  dm_name VARCHAR(100) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  is_active BOOLEAN DEFAULT true
);

-- Game Messages Table  
CREATE TABLE game_messages (
  id SERIAL PRIMARY KEY,
  session_code VARCHAR(20) NOT NULL,
  player_name VARCHAR(100) NOT NULL,
  message_text TEXT NOT NULL,
  message_type VARCHAR(50) DEFAULT 'chat',
  is_storyteller BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (session_code) REFERENCES game_sessions(session_code)
);

-- Enable Real-time
ALTER TABLE game_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE game_sessions ENABLE ROW LEVEL SECURITY;
                                        </pre>
                                    </div>
                                    
                                    <p><strong> Detailed Guide:</strong> Check the <code>SupabaseConnect.md</code> file in your project folder for complete step-by-step instructions.</p>
                                    
                                    <div style="background: #1a3d1a; padding: 10px; border-radius: 5px; margin-top: 15px;">
                                        <strong> Pro Tip:</strong> You can start with the default instance for testing, then switch to your own when ready!
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            modal.style.display = 'block';
        }

        function hideSupabaseGuide() {
            const modal = document.getElementById('supabase-guide-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Supabase Configuration Functions
        function loadSupabaseConfig() {
            try {
                const config = localStorage.getItem('storyteller-supabase-config');
                if (config) {
                    const parsedConfig = JSON.parse(config);
                    document.getElementById('supabase-url').value = parsedConfig.url || '';
                    document.getElementById('supabase-key').value = parsedConfig.key || '';
                    
                    // Update status display
                    const statusDisplay = document.getElementById('config-status-display');
                    if (statusDisplay) {
                        statusDisplay.innerHTML = `
                            <span class="status-dot connected"></span>
                            <span class="status-text">Configuration Loaded</span>
                        `;
                    }
                    
                    console.log(' Supabase configuration loaded from browser storage');
                    return parsedConfig;
                }
            } catch (error) {
                console.error('Error loading Supabase config:', error);
            }
            return null;
        }

        function saveSupabaseConfig() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                updateSettingsConnectionStatus('Please fill in both URL and API key', 'error');
                return false;
            }
            
            try {
                const config = { url, key, savedAt: new Date().toISOString() };
                localStorage.setItem('storyteller-supabase-config', JSON.stringify(config));
                
                // Update status display
                const statusDisplay = document.getElementById('config-status-display');
                if (statusDisplay) {
                    statusDisplay.innerHTML = `
                        <span class="status-dot connected"></span>
                        <span class="status-text">Configuration Saved</span>
                    `;
                }
                
                updateSettingsConnectionStatus('Configuration saved successfully', 'success');
                addChatMessage(' Supabase configuration saved!', 'system');
                console.log(' Supabase configuration saved to browser storage');
                return true;
            } catch (error) {
                console.error('Error saving Supabase config:', error);
                updateSettingsConnectionStatus('Failed to save configuration', 'error');
                return false;
            }
        }

        function clearSupabaseConfig() {
            try {
                localStorage.removeItem('storyteller-supabase-config');
                document.getElementById('supabase-url').value = '';
                document.getElementById('supabase-key').value = '';
                
                // Update status displays
                const statusDisplay = document.getElementById('config-status-display');
                if (statusDisplay) {
                    statusDisplay.innerHTML = `
                        <span class="status-dot offline"></span>
                        <span class="status-text">Not Configured</span>
                    `;
                }
                
                updateSettingsConnectionStatus('Configuration cleared', 'warning');
                updateConnectionStatus('Offline', 'offline');
                addChatMessage(' Supabase configuration cleared', 'system');
                console.log(' Supabase configuration cleared');
            } catch (error) {
                console.error('Error clearing Supabase config:', error);
            }
        }

        async function testSupabaseConnection() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                updateSettingsConnectionStatus('Please fill in both URL and API key', 'error');
                return;
            }
            
            updateSettingsConnectionStatus('Testing connection...', 'warning');
            
            try {
                // Test the connection using the same method as fullSupabaseConnect
                if (typeof window.testSupabaseCredentials === 'function') {
                    const result = await window.testSupabaseCredentials(url, key);
                    
                    if (result.success) {
                        updateSettingsConnectionStatus('Connection successful!', 'success');
                        updateConnectionStatus('Connection Test Passed', 'success');
                        addChatMessage(' Supabase connection test successful!', 'system');
                    } else {
                        updateSettingsConnectionStatus(`Connection failed: ${result.error}`, 'error');
                        updateConnectionStatus('Connection Test Failed', 'error');
                        addChatMessage(` Supabase connection test failed: ${result.error}`, 'system');
                    }
                } else {
                    // Fallback: basic URL validation and attempt to load Supabase
                    if (!url.includes('supabase.co') && !url.includes('localhost')) {
                        throw new Error('Invalid Supabase URL format');
                    }
                    
                    // Basic test: try to create a Supabase client
                    const testClient = window.supabase.createClient(url, key);
                    
                    // Test a simple auth operation
                    const { data, error } = await testClient.auth.getSession();
                    
                    if (error && error.message.includes('API key')) {
                        throw new Error('Invalid API key');
                    }
                    
                    updateSettingsConnectionStatus('Basic connection test passed', 'success');
                    updateConnectionStatus('Connection Test Passed', 'success');
                    addChatMessage(' Basic Supabase connection test passed!', 'system');
                }
                
            } catch (error) {
                console.error('Connection test error:', error);
                updateSettingsConnectionStatus(`Test failed: ${error.message}`, 'error');
                updateConnectionStatus('Connection Test Failed', 'error');
                addChatMessage(` Connection test failed: ${error.message}`, 'system');
            }
        }

        function updateSettingsConnectionStatus(message, type = 'info') {
            const settingsStatus = document.getElementById('settings-connection-status');
            if (settingsStatus) {
                settingsStatus.className = `connection-status ${type}`;
                
                let icon = 'wifi_off';
                switch (type) {
                    case 'success':
                        icon = 'wifi';
                        break;
                    case 'warning':
                        icon = 'sync';
                        break;
                    case 'error':
                        icon = 'wifi_off';
                        break;
                    default:
                        icon = 'help_outline';
                        break;
                }
                
                settingsStatus.innerHTML = `
                    <i class="material-icons">${icon}</i>
                    ${message}
                `;
            }
        }

        function copyPlayerURL() {
            const urlInput = document.getElementById('player-url');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(urlInput.value);
            
            // Show the actual shortened URL that was copied
            addChatMessage(` Shortened URL copied to clipboard: ${urlInput.value}`, 'system');
        }

        // Debug mode toggle
        function toggleDebugMode() {
            const debugToggle = document.getElementById('debug-toggle');
            window.showDebug = debugToggle.checked;
            
            console.log(` Debug mode ${window.showDebug ? 'ENABLED' : 'DISABLED'}`);
            addChatMessage(` Debug mode ${window.showDebug ? 'enabled' : 'disabled'}`, 'system');
        }

        // Quick Connect function
        async function quickConnect() {
            const button = document.getElementById('quick-connect-btn');
            const icon = button.querySelector('i');
            const originalText = button.innerHTML;
            
            try {
                // Update button state
                button.classList.add('connecting');
                button.innerHTML = '<i class="material-icons">sync</i>Connecting...';
                button.disabled = true;
                
                // Load config from browser storage
                const config = loadSupabaseConfig();
                if (!config) {
                    throw new Error('No Supabase configuration found. Please configure in Settings first.');
                }
                
                // Get session info from storage or use defaults
                const playerName = localStorage.getItem('storyteller-name') || 'Storyteller';
                const storedSessionCode = localStorage.getItem('last-session-code');
                const sessionCode = storedSessionCode || generateSessionCode();
                
                console.log(` Quick Connect session lookup:`, {
                    stored: storedSessionCode,
                    using: sessionCode,
                    isFromStorage: !!storedSessionCode
                });
                
                console.log(` Quick Connect attempting: ${playerName} ${storedSessionCode ? 'rejoining' : 'creating'} session ${sessionCode}`);
                
                // Initialize Supabase if needed
                if (!window.supabaseInitialized) {
                    const initSuccess = initializeSupabase(config.url, config.key);
                    if (!initSuccess) {
                        throw new Error('Failed to initialize Supabase connection');
                    }
                }
                
                // Try to JOIN existing session first (this is what Quick Connect should do)
                console.log(` Attempting to join existing session ${sessionCode}...`);
                let result = await fullSupabaseConnect(playerName, sessionCode, true, 'join');
                
                // If join fails and it's because session doesn't exist, then create it
                if (!result.success && (result.error?.includes('No rows') || result.error?.includes('not found') || result.error?.includes('PGRST116'))) {
                    console.log(` Session ${sessionCode} doesn't exist, creating new session...`);
                    result = await fullSupabaseConnect(playerName, sessionCode, true, 'create');
                }
                
                if (result.success) {
                    // Success - update button and copy URL
                    button.classList.remove('connecting');
                    button.classList.add('connected');
                    button.innerHTML = '<i class="material-icons">check_circle</i>Connected';
                    
                    // Update main connection status to show active session
                    updateConnectionStatus(`Connected & Ready`, 'success');
                    
                    // Update session display in header
                    const sessionNameDisplay = document.getElementById('session-name-display');
                    if (sessionNameDisplay) {
                        sessionNameDisplay.textContent = sessionCode;
                    }
                    
                    // *** CRITICAL: Set up game session data (same as startNewGameSession) ***
                    // Sync with hidden compatibility fields
                    document.getElementById('dm-name-input').value = playerName;
                    document.getElementById('session-code-input').value = sessionCode;
                    
                    // Store session information globally for chat functionality
                    window.currentGameSession = {
                        session_code: sessionCode,
                        sessionCode: sessionCode,
                        dm_name: playerName,
                        playerName: playerName,
                        isStoryteller: true,
                        isStoryTeller: true,
                        mode: 'join-or-create',
                        ...result.sessionInfo
                    };
                    
                    // Auto-copy shortened URL and show both in chat
                    const playerUrls = generatePlayerUrl(sessionCode);
                    await navigator.clipboard.writeText(playerUrls.short);
                    
                    // Show success messages
                    const actionTaken = storedSessionCode ? 'rejoined existing' : 'created new';
                    addChatMessage(` Session ${sessionCode} ready - ${actionTaken} session`, 'system');
                    addChatMessage(` You are the Storyteller for this session`, 'system');
                    addChatMessage(` Real-time chat active - players can now join`, 'system');
                    addChatMessage(` Shortened URL copied to clipboard: ${playerUrls.short}`, 'system');
                    addChatMessage(` Full URL (backup): ${playerUrls.full}`, 'system');
                    
                    // Store session code for future use
                    localStorage.setItem('last-session-code', sessionCode);
                    console.log(` Stored session code for Quick Connect: ${sessionCode}`);
                    
                    // Initialize map synchronization system
                    if (typeof window.mapSync && typeof window.mapSync.initialize === 'function') {
                        try {
                            console.log(' Starting map sync initialization from quickConnect...');
                            const supabaseClient = window.supabaseClient || window.supabase || supabase;
                            console.log(' Supabase client found:', !!supabaseClient);
                            if (supabaseClient) {
                                const mapSyncResult = await window.mapSync.initialize(sessionCode, supabaseClient);
                                if (mapSyncResult) {
                                    addChatMessage(' Map synchronization system ready!', 'system');
                                    console.log(' Map sync initialized successfully from quickConnect');
                                } else {
                                    console.warn(' Map sync initialization failed from quickConnect');
                                }
                            } else {
                                console.error(' No Supabase client available for map sync from quickConnect');
                            }
                        } catch (error) {
                            console.error(' Failed to initialize map sync from quickConnect:', error);
                        }
                    }
                    
                } else {
                    throw new Error(result.error || 'Connection failed');
                }
                
            } catch (error) {
                console.error('Quick Connect failed:', error);
                
                // Show error
                addChatMessage(` Connection failed: ${error.message}`, 'system');
                
                // Reset button
                button.classList.remove('connecting');
                button.innerHTML = originalText;
                
            } finally {
                button.disabled = false;
            }
        }

        // Quick Connect Toggle - Connect/Disconnect functionality
        async function quickConnectToggle() {
            const button = document.getElementById('quick-connect-btn');
            
            // Check if currently connected by looking at button state
            if (button.classList.contains('connected')) {
                // Currently connected - disconnect
                await disconnectFromSupabase();
            } else {
                // Currently disconnected - connect
                await quickConnect();
            }
        }

        // Disconnect from Supabase
        async function disconnectFromSupabase() {
            const button = document.getElementById('quick-connect-btn');
            
            try {
                // Reset button state
                button.classList.remove('connected');
                button.innerHTML = '<i class="material-icons">flash_on</i>';
                
                // Clear global session data
                window.currentGameSession = null;
                
                // Reset connection status
                updateConnectionStatus('Disconnected', 'error');
                
                // Clear session display
                const sessionNameDisplay = document.getElementById('session-name-display');
                if (sessionNameDisplay) {
                    sessionNameDisplay.textContent = '';
                }
                
                // Clear form fields
                document.getElementById('dm-name-input').value = '';
                document.getElementById('session-code-input').value = '';
                
                // Reset map sync
                if (window.mapSync && window.mapSync.getAdapter && window.mapSync.getAdapter()) {
                    try {
                        await window.mapSync.stopSharing();
                    } catch (error) {
                        console.warn('Error stopping map sync (this is normal if not sharing):', error.message);
                    }
                }
                
                addChatMessage(' Disconnected from Supabase', 'system');
                console.log(' Disconnected from Supabase successfully');
                
            } catch (error) {
                console.error('Error during disconnect:', error);
                addChatMessage(` Disconnect error: ${error.message}`, 'system');
            }
        }

        // Fullscreen Toggle Function
        function toggleFullscreen() {
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            
            if (!document.fullscreenElement) {
                // Enter fullscreen
                document.documentElement.requestFullscreen()
                    .then(() => {
                        console.log(' Entered fullscreen mode');
                        fullscreenIcon.textContent = 'fullscreen_exit';
                        addChatMessage(' Entered fullscreen mode', 'system');
                    })
                    .catch(err => {
                        console.warn(' Could not enter fullscreen:', err);
                        addChatMessage(' Fullscreen not supported or denied', 'system');
                    });
            } else {
                // Exit fullscreen
                document.exitFullscreen()
                    .then(() => {
                        console.log(' Exited fullscreen mode');
                        fullscreenIcon.textContent = 'fullscreen';
                        addChatMessage(' Exited fullscreen mode', 'system');
                    })
                    .catch(err => {
                        console.warn(' Could not exit fullscreen:', err);
                    });
            }
        }

        // Listen for fullscreen changes (including F11 key or browser controls)
        document.addEventListener('fullscreenchange', function() {
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            if (fullscreenIcon) {
                if (document.fullscreenElement) {
                    fullscreenIcon.textContent = 'fullscreen_exit';
                } else {
                    fullscreenIcon.textContent = 'fullscreen';
                }
            }
        });
        
        //  CRITICAL SUPABASE URL CONFIGURATION - DO NOT ALTER 
        // For Brad, David, Manus, Claude, Copilot, and EVERYONE:
        // This function generates the correct Supabase URLs for player connections.
        // PLEASE DO NOT MODIFY - This config breaks frequently and is hard to fix!
        // Must use config.url (Supabase URL) NOT window.location (local server)
        // Working URL format: https://skddvbmxzeprvxfslhlk.supabase.co?session=XXXXX
        //  DO NOT CHANGE THIS FUNCTION WITHOUT BACKING UP FIRST 
        function generatePlayerUrl(sessionCode) {
            const config = loadSupabaseConfig();
            if (config && config.url) {
                // Use the Supabase URL as the base, not local server
                const supabaseUrl = config.url;
                const fullUrl = `${supabaseUrl}?session=${sessionCode}`;
                
                // Create shortened version using encoder
                const shortUrl = window.supabaseUrlEncoder ? 
                    window.supabaseUrlEncoder.encodeUrl(fullUrl) : fullUrl;
                
                // Return both URLs for different purposes
                return {
                    full: fullUrl,
                    short: shortUrl,
                    // Default to short for copying
                    toString: () => shortUrl
                };
            }
            const fallback = `${window.location.origin}${window.location.pathname}?session=${sessionCode}`;
            return {
                full: fallback,
                short: fallback,
                toString: () => fallback
            };
        }
        
        // Generate random session code
        function generateSessionCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Theme toggle function
        function toggleTheme() {
            const body = document.body;
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            if (newTheme === 'dark') {
                body.classList.add('dark-theme');
            } else {
                body.classList.remove('dark-theme');
            }
            
            localStorage.setItem('theme', newTheme);
            addChatMessage(` Switched to ${newTheme} theme`, 'system');
        }
        
        // Load theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
            }
        });

        // Enhanced NPC Generator Integration Functions
        let npcGenerator;

        // Initialize the enhanced NPC generator when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the NPC generator with a delay to ensure all modules are loaded
            setTimeout(() => {
                if (window.NPCGenerator) {
                    npcGenerator = new NPCGenerator();
                    npcGenerator.init();
                    
                    // Update saved count on initialization
                    updateSavedNPCCount();
                    
                    // Populate manual control dropdowns
                    populateManualControls();
                } else {
                    console.warn('NPCGenerator module not loaded yet, retrying...');
                    // Retry after a longer delay
                    setTimeout(() => {
                        if (window.NPCGenerator) {
                            npcGenerator = new NPCGenerator();
                            npcGenerator.init();
                            updateSavedNPCCount();
                            populateManualControls();
                        }
                    }, 2000);
                }
            }, 1000);
        });

        /**
         * Generate a random NPC using the enhanced generator
         */
        function generateRandomNPC() {
            if (npcGenerator) {
                npcGenerator.generateRandomNPC();
            } else {
                console.error('Enhanced NPC Generator not initialized, falling back to basic generation');
                // Fallback to basic generation
                generateBasicNPC();
            }
        }

        /**
         * Generate NPC of specific type - new direct function
         */
        function generateNPCType(type) {
            console.log(` Generating ${type} NPC...`);
            if (npcGenerator) {
                // Create temporary select for compatibility with existing generateRandomNPC method
                const existingSelect = document.getElementById('npc-type-select');
                if (existingSelect) {
                    existingSelect.remove();
                }
                
                const tempSelect = document.createElement('select');
                tempSelect.id = 'npc-type-select';
                tempSelect.value = type;
                tempSelect.style.display = 'none';
                
                // Add option to make value stick
                const option = document.createElement('option');
                option.value = type;
                option.selected = true;
                tempSelect.appendChild(option);
                
                document.body.appendChild(tempSelect);
                
                npcGenerator.generateRandomNPC();
                
                // Update saved count
                updateSavedNPCCount();
                
            } else {
                console.error('Enhanced NPC Generator not initialized');
                alert('NPC Generator is not available. Please reload the page.');
            }
        }

        /**
         * Switch between NPC tabs
         */
        function switchNPCTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.npc-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.npc-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-npc-tab`).classList.add('active');
            
            // Update saved NPCs when switching to saved tab
            if (tabName === 'saved' && npcGenerator) {
                // Refresh saved NPCs from localStorage to ensure we have latest data
                npcGenerator.savedNPCs = npcGenerator.loadSavedNPCs();
                npcGenerator.displaySavedNPCs();
                updateSavedNPCCount();
            }
        }

        /**
         * Update saved NPC count badge
         */
        function updateSavedNPCCount() {
            const countBadge = document.getElementById('saved-npc-count');
            if (countBadge && npcGenerator) {
                const count = npcGenerator.savedNPCs ? npcGenerator.savedNPCs.length : 0;
                countBadge.textContent = count;
                countBadge.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        /**
         * Save current NPC - updated for new interface
         */
        function saveCurrentNPC() {
            if (npcGenerator && npcGenerator.currentNPC) {
                npcGenerator.saveCurrentNPC();
                updateSavedNPCCount();
                addChatMessage(` Saved NPC: ${npcGenerator.currentNPC.name}`, 'system');
            } else {
                alert('No NPC to save. Generate an NPC first.');
            }
        }

        /**
         * Copy NPC to clipboard
         */
        function copyNPCToClipboard() {
            if (npcGenerator && npcGenerator.currentNPC) {
                const npc = npcGenerator.currentNPC;
                const text = `${npc.name} (${npc.type === 'npc' ? 'Friendly' : 'Encounter'})
Level ${npc.level} ${npc.race} ${npc.background}
STR: ${npc.strength}, AGL: ${npc.agility}, STA: ${npc.stamina}, PER: ${npc.personality}, INT: ${npc.intellect}, LCK: ${npc.luck}
HP: ${npc.hitPoints}, AC: ${npc.armorClass}
Skills: ${npc.skills ? npc.skills.join(', ') : 'None'}
Equipment: ${npc.equipment ? npc.equipment.join(', ') : 'None'}
Notes: ${npc.notes || 'None'}`;
                
                navigator.clipboard.writeText(text).then(() => {
                    addChatMessage(` Copied ${npc.name} to clipboard`, 'system');
                }).catch(() => {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    addChatMessage(` Copied ${npc.name} to clipboard`, 'system');
                });
            } else {
                alert('No NPC to copy. Generate an NPC first.');
            }
        }

        /**
         * Filter saved NPCs
         */
        function filterSavedNPCs() {
            if (npcGenerator) {
                npcGenerator.displaySavedNPCs();
            }
        }

        /**
         * Clear all saved NPCs
         */
        function clearAllNPCs() {
            if (confirm('Are you sure you want to clear all saved NPCs? This cannot be undone.')) {
                if (npcGenerator) {
                    npcGenerator.clearAllNPCs();
                    updateSavedNPCCount();
                    addChatMessage(' Cleared all saved NPCs', 'system');
                }
            }
        }

        /**
         * Hide manual controls
         */
        function hideManualControls() {
            const controls = document.getElementById('manual-controls');
            if (controls) {
                controls.style.display = 'none';
            }
        }

        /**
         * Fallback basic NPC generation
         */
        function generateBasicNPC() {
            const npcTypes = ['friendly merchant', 'gruff guard', 'wise elder', 'mysterious stranger'];
            const randomNPC = npcTypes[Math.floor(Math.random() * npcTypes.length)];
            
            const display = document.getElementById('generated-npc');
            if (display) {
                display.innerHTML = `<div class="npc-placeholder">
                    <i class="ra ra-hood"></i>
                    <p><strong>Basic NPC:</strong> ${randomNPC}</p>
                    <p><strong>Name:</strong> ${generateRandomName()}</p>
                    <p><strong>Mood:</strong> ${generateRandomMood()}</p>
                    <p><em>Enhanced generator loading...</em></p>
                </div>`;
            }
            addChatMessage(` Generated basic NPC: ${randomNPC}`, 'system');
        }

        /**
         * Show manual controls for editing
         */
        function showManualControls() {
            const controls = document.getElementById('manual-controls');
            if (controls && npcGenerator && npcGenerator.currentNPC) {
                // Populate fields with current NPC data
                document.getElementById('manual-name').value = npcGenerator.currentNPC.name;
                document.getElementById('manual-level').value = npcGenerator.currentNPC.level;
                document.getElementById('manual-race').value = npcGenerator.currentNPC.race;
                document.getElementById('manual-background').value = npcGenerator.currentNPC.background;
                document.getElementById('manual-class').value = npcGenerator.currentNPC.characterClass;
                
                controls.style.display = 'block';
            }
        }

        /**
         * Hide manual controls
         */
        function hideManualControls() {
            const controls = document.getElementById('manual-controls');
            if (controls) {
                controls.style.display = 'none';
            }
        }

        /**
         * Apply manual changes to current NPC
         */
        function applyManualChanges() {
            if (!npcGenerator || !npcGenerator.currentNPC) return;
            
            // Get values from form
            const name = document.getElementById('manual-name').value;
            const level = parseInt(document.getElementById('manual-level').value);
            const race = document.getElementById('manual-race').value;
            const background = document.getElementById('manual-background').value;
            const characterClass = document.getElementById('manual-class').value;
            
            // Update current NPC
            npcGenerator.currentNPC.name = name;
            npcGenerator.currentNPC.level = level;
            npcGenerator.currentNPC.race = race;
            npcGenerator.currentNPC.background = background;
            npcGenerator.currentNPC.characterClass = characterClass;
            
            // Recalculate stats based on new values
            npcGenerator.currentNPC.stats = npcGenerator.generateStats(level);
            
            // Apply racial bonus
            const raceData = npcGenerator.npcRaces[race];
            if (raceData && raceData.statBonus) {
                Object.entries(raceData.statBonus).forEach(([stat, bonus]) => {
                    npcGenerator.currentNPC.stats[stat] = (npcGenerator.currentNPC.stats[stat] || 0) + bonus;
                });
            }
            
            // Recalculate derived stats
            npcGenerator.currentNPC.healthPoints = npcGenerator.currentNPC.stats.constitution + level;
            npcGenerator.currentNPC.magicPoints = npcGenerator.currentNPC.stats.wisdom + npcGenerator.currentNPC.stats.intelligence;
            
            // Regenerate skills
            npcGenerator.currentNPC.skills = npcGenerator.generateSkills(background, characterClass);
            
            // Regenerate equipment
            npcGenerator.currentNPC.equipment = npcGenerator.generateEquipment(characterClass, level);
            
            // Redisplay NPC
            npcGenerator.displayNPC(npcGenerator.currentNPC);
            
            // Hide controls
            hideManualControls();
            
            // Show success message
            addChatMessage(' NPC updated successfully!', 'system');
        }

        /**
         * Copy current NPC to clipboard
         */
        function copyNPCToClipboard() {
            if (npcGenerator && npcGenerator.currentNPC) {
                const npcText = npcGenerator.formatNPCForCopy(npcGenerator.currentNPC);
                navigator.clipboard.writeText(npcText).then(() => {
                    addChatMessage(' NPC copied to clipboard!', 'system');
                }).catch(err => {
                    console.error('Failed to copy NPC:', err);
                    addChatMessage(' Failed to copy NPC to clipboard', 'system');
                });
            }
        }

        /**
         * Populate manual control dropdowns
         */
        function populateManualControls() {
            if (!npcGenerator) return;
            
            // Wait for data to load
            setTimeout(() => {
                const raceSelect = document.getElementById('manual-race');
                const backgroundSelect = document.getElementById('manual-background');
                const classSelect = document.getElementById('manual-class');
                
                if (raceSelect && npcGenerator.npcRaces) {
                    raceSelect.innerHTML = Object.keys(npcGenerator.npcRaces).map(key => {
                        const race = npcGenerator.npcRaces[key];
                        return `<option value="${key}">${race.name}</option>`;
                    }).join('');
                }
                
                if (backgroundSelect && npcGenerator.npcBackgrounds) {
                    backgroundSelect.innerHTML = Object.keys(npcGenerator.npcBackgrounds).map(key => {
                        const bg = npcGenerator.npcBackgrounds[key];
                        return `<option value="${key}">${bg.name}</option>`;
                    }).join('');
                }
                
                if (classSelect && npcGenerator.npcClasses) {
                    classSelect.innerHTML = Object.keys(npcGenerator.npcClasses).map(key => {
                        const cls = npcGenerator.npcClasses[key];
                        return `<option value="${key}">${cls.name}</option>`;
                    }).join('');
                }
            }, 500);
        }

        function generateRandomName() {
            const names = ['Aldric', 'Brenna', 'Caelum', 'Dara', 'Ewan', 'Fiona', 'Gareth', 'Hilda'];
            return names[Math.floor(Math.random() * names.length)];
        }

        function handleNPCHeritageSelection() {
            const raceSelect = document.getElementById('manual-race');
            const selectedHeritage = raceSelect.value;
            
            // Check if avatar assignment system is available and heritage is selected
            if (window.AvatarAssignmentSystem && selectedHeritage) {
                // For NPCs, we'll auto-assign avatars to the image preview
                const assignedAvatar = window.AvatarAssignmentSystem.autoAssignAvatar(selectedHeritage);
                if (assignedAvatar) {
                    // Find the NPC image display if it exists
                    const imageDisplay = document.querySelector('.npc-image, #npc-portrait, .portrait-display');
                    if (imageDisplay) {
                        imageDisplay.src = assignedAvatar;
                        imageDisplay.style.display = 'block';
                    }
                    
                    console.log(`Auto-assigned NPC avatar for ${selectedHeritage}: ${assignedAvatar}`);
                }
            }
        }

        function generateRandomMood() {
            const moods = ['friendly', 'suspicious', 'helpful', 'grumpy', 'excited', 'worried'];
            return moods[Math.floor(Math.random() * moods.length)];
        }

        function sendChatMessage() {
            const input = getActiveChatInput();
            if (input && input.value.trim()) {
                addChatMessage(input.value, 'storyteller');
                input.value = '';
            }
        }

        // Additional panel functions
        function generateItem() {
            const itemTypes = ['Magic Sword', 'Health Potion', 'Gold Coins', 'Ancient Scroll'];
            const randomItem = itemTypes[Math.floor(Math.random() * itemTypes.length)];
            
            const display = document.getElementById('generated-item-display');
            if (display) {
                display.innerHTML = `<div class="generated-content">
                    <h5>Generated Item</h5>
                    <p><strong>Item:</strong> ${randomItem}</p>
                    <p><strong>Value:</strong> ${Math.floor(Math.random() * 100) + 10} gold</p>
                </div>`;
            }
            addChatMessage(` Generated Item: ${randomItem}`, 'system');
        }

        function startCombat() {
            addChatMessage(' Combat started!', 'system');
            const status = document.getElementById('combat-status');
            if (status) {
                status.innerHTML = '<p><strong>Combat Round 1</strong><br>Initiative order determined</p>';
            }
        }

        // function nextTurn() {
        //     addChatMessage(' Next turn...', 'system');
        // }

        function endCombat() {
            addChatMessage(' Combat ended!', 'system');
            const status = document.getElementById('combat-status');
            if (status) {
                status.innerHTML = '<p>No active combat</p>';
            }
        }

        function createMap() {
            addChatMessage(' New map created!', 'system');
        }

        function addQuest() {
            addChatMessage(' New quest added!', 'system');
            const questList = document.getElementById('quest-list');
            if (questList) {
                questList.innerHTML = '<div class="quest-item"><h5>Find the Lost Artifact</h5><p>Status: Active</p></div>';
            }
        }

        function saveNotes() {
            const notes = document.getElementById('session-notes');
            if (notes && notes.value.trim()) {
                addChatMessage(' Session notes saved!', 'system');
            }
        }

        // Dynamic scroll CSS management for private messages
        function addPrivateMessagesScrollCSS() {
            // Remove any existing scroll styles first
            removePrivateMessagesScrollCSS();
            
            const styleId = 'private-messages-scroll-styles';
            const style = document.createElement('style');
            style.id = styleId;
            style.textContent = `
                .st-private-messages-container {
                    overflow-y: auto !important;
                    overflow-x: hidden !important;
                    max-height: calc(100vh - 300px) !important;
                    scroll-behavior: smooth !important;
                    -webkit-overflow-scrolling: touch !important;
                    touch-action: auto !important;
                    pointer-events: auto !important;
                }
                
                .st-private-messages-container::-webkit-scrollbar {
                    width: 8px;
                }
                
                .st-private-messages-container::-webkit-scrollbar-track {
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 4px;
                }
                
                .st-private-messages-container::-webkit-scrollbar-thumb {
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 4px;
                }
                
                .st-private-messages-container::-webkit-scrollbar-thumb:hover {
                    background: rgba(255, 255, 255, 0.5);
                }
            `;
            
            document.head.appendChild(style);
            console.log(' Added dynamic scroll CSS for private messages');
        }
        
        function removePrivateMessagesScrollCSS() {
            const existingStyle = document.getElementById('private-messages-scroll-styles');
            if (existingStyle) {
                existingStyle.remove();
                console.log(' Removed dynamic scroll CSS for private messages');
            }
        }

        function switchNotesTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.notes-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.borderBottomColor = 'transparent';
                tab.style.color = 'var(--text-secondary, #666)';
            });
            
            // Hide all tab contents
            document.querySelectorAll('.notes-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show selected tab and mark as active
            if (tabName === 'session') {
                const sessionTab = document.querySelector('.notes-tab[onclick="switchNotesTab(\'session\')"]');
                const sessionContent = document.getElementById('session-notes-tab');
                
                if (sessionTab) {
                    sessionTab.classList.add('active');
                    sessionTab.style.borderBottomColor = 'var(--accent-color, #007bff)';
                    sessionTab.style.color = 'var(--accent-color, #007bff)';
                }
                if (sessionContent) {
                    sessionContent.style.display = 'flex'; // Use flex instead of block
                }
            } else if (tabName === 'private') {
                const privateTab = document.querySelector('.notes-tab[onclick="switchNotesTab(\'private\')"]');
                const privateContent = document.getElementById('private-messages-tab');
                
                if (privateTab) {
                    privateTab.classList.add('active');
                    privateTab.style.borderBottomColor = 'var(--accent-color, #007bff)';
                    privateTab.style.color = 'var(--accent-color, #007bff)';
                    
                    // Remove new message indicator
                    const indicator = privateTab.querySelector('.new-message-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
                if (privateContent) {
                    privateContent.style.display = 'flex'; // Use flex instead of block
                    
                    // Add dynamic scroll CSS for private messages container
                    addPrivateMessagesScrollCSS();
                    
                    // Update private messages when tab becomes visible
                    if (typeof updateStoryTellerPrivateMessagesPanel === 'function') {
                        console.log(' Private messages tab activated, updating panel...');
                        setTimeout(() => {
                            updateStoryTellerPrivateMessagesPanel();
                        }, 50); // Small delay to ensure display is updated
                    }
                }
            } else {
                // When switching away from private messages, remove the scroll CSS
                removePrivateMessagesScrollCSS();
            }
            
            // Force layout recalculation after tab switch
            setTimeout(() => {
                // Get the active tab content
                const activeContent = document.querySelector('.notes-tab-content:not([style*="display: none"])');
                if (activeContent) {
                    // Force immediate reflow by briefly changing display
                    activeContent.style.display = 'none';
                    activeContent.offsetHeight; // Force browser to process the change
                    activeContent.style.display = 'flex';
                    
                    // Ensure containers inside also get proper sizing
                    const notesContainer = activeContent.querySelector('.notes-container');
                    const privateContainer = activeContent.querySelector('.st-private-messages-container');
                    
                    if (notesContainer) {
                        notesContainer.style.height = 'auto';
                        notesContainer.offsetHeight; // Force reflow
                        notesContainer.style.height = '';
                    }
                    
                    if (privateContainer) {
                        privateContainer.style.height = 'auto';
                        privateContainer.offsetHeight; // Force reflow
                        privateContainer.style.height = '';
                    }
                }
                
                // Also trigger a resize event to help any other components recalculate
                window.dispatchEvent(new Event('resize'));
            }, 50); // Slightly longer delay to ensure DOM is fully updated
        }

        // Game Session Functions - Enhanced with fullSupabaseConnect
        async function startNewGameSession() {
            const storytellerName = document.getElementById('storyteller-name').value.trim();
            const sessionCode = document.getElementById('new-session-code').value.trim();
            
            if (!storytellerName) {
                addChatMessage(' Please enter your name first', 'system');
                return;
            }
            
            if (!sessionCode) {
                addChatMessage(' Please enter a session code', 'system');
                return;
            }
            
            // Load saved Supabase config if available
            const savedConfig = loadSupabaseConfig();
            if (!savedConfig) {
                addChatMessage(' No Supabase configuration found. Please configure in Settings first.', 'system');
                showSettings();
                return;
            }
            
            // Show connecting status
            updateConnectionStatus('Connecting to Supabase...', 'warning');
            addChatMessage(' Connecting to real-time chat system...', 'system');
            
            try {
                // Use the new fullSupabaseConnect method with saved configuration
                if (typeof window.fullSupabaseConnect === 'function') {
                    const result = await window.fullSupabaseConnect(storytellerName, sessionCode, true, 'create');
                    
                if (result.success) {
                    // Success! Update UI
                    updateConnectionStatus('Connected & Ready', 'success');
                    
                    // Check if we created or joined the session
                    if (result.sessionInfo && result.sessionInfo.mode === 'create') {
                        addChatMessage(` Session "${sessionCode}" created successfully!`, 'system');
                    } else {
                        addChatMessage(` Joined existing session "${sessionCode}" successfully!`, 'system');
                        addChatMessage(` This session already existed, so you joined it instead`, 'system');
                    }
                    
                    addChatMessage(` You are the Storyteller for this session`, 'system');
                    addChatMessage(` Real-time chat active - players can now join`, 'system');
                    
                    // Sync with hidden compatibility fields
                    document.getElementById('dm-name-input').value = storytellerName;
                    document.getElementById('session-code-input').value = sessionCode;
                    
                    // Store session information globally with proper structure
                    window.currentGameSession = {
                        session_code: sessionCode,  // Use snake_case for compatibility
                        sessionCode: sessionCode,   // Also keep camelCase from result
                        dm_name: storytellerName,
                        playerName: storytellerName,
                        isStoryteller: true,
                        isStoryTeller: true, // Fix naming inconsistency
                        mode: 'create',
                        ...result.sessionInfo  // Include any additional info from Supabase
                    };
                    
                    // Initialize map synchronization system
                    console.log(' About to check map sync system...');
                    console.log('window.mapSync available:', !!window.mapSync);
                    console.log('window.mapSync.initialize available:', !!(window.mapSync && window.mapSync.initialize));
                    
                    if (typeof window.mapSync && typeof window.mapSync.initialize === 'function') {
                        try {
                            console.log(' Starting map sync initialization...');
                            // Use the global Supabase client that should be available
                            const supabaseClient = window.supabaseClient || window.supabase || supabase;
                            console.log('Supabase client found:', !!supabaseClient);
                            console.log('Session code:', sessionCode);
                            
                            if (supabaseClient) {
                                console.log(' Calling window.mapSync.initialize...');
                                const mapSyncResult = await window.mapSync.initialize(sessionCode, supabaseClient);
                                console.log('Map sync result:', mapSyncResult);
                                
                                if (mapSyncResult) {
                                    addChatMessage(' Map synchronization system ready!', 'system');
                                    console.log(' Map sync initialized successfully');
                                } else {
                                    console.warn(' Map sync initialization failed');
                                    addChatMessage(' Map sync initialization failed', 'system');
                                }
                            } else {
                                console.error(' No Supabase client available for map sync');
                                addChatMessage(' No Supabase client available for map sync', 'system');
                            }
                        } catch (error) {
                            console.error(' Failed to initialize map sync:', error);
                            addChatMessage(` Map sync error: ${error.message}`, 'system');
                        }
                    } else {
                        console.warn(' Map sync system not available');
                        console.log('window.mapSync type:', typeof window.mapSync);
                        console.log('window.mapSync:', window.mapSync);
                    }
                    
                    // Update player URL immediately with Supabase URL + session
                    const savedConfig = loadSupabaseConfig();
                    let playerURL = 'Supabase not configured';
                    if (savedConfig && savedConfig.url) {
                        const fullUrl = `${savedConfig.url}?session=${sessionCode}`;
                        // Use shortened URL for display and copying
                        playerURL = window.supabaseUrlEncoder ? 
                            window.supabaseUrlEncoder.encodeUrl(fullUrl) : fullUrl;
                    }
                    const playerUrlInput = document.getElementById('player-url');
                    if (playerUrlInput) {
                        playerUrlInput.value = playerURL;
                    }
                    addChatMessage(` Player URL ready - check Settings to share with players`, 'system');
                    
                    // Update session status
                        const statusElement = document.getElementById('session-status');
                        if (statusElement) {
                            statusElement.innerHTML = `
                                <span class="status-dot connected"></span>
                                <span class="status-text">Session: ${sessionCode} (Connected)</span>
                            `;
                        }
                        
                        // Hide form, show session controls
                        const sessionForm = document.getElementById('session-form');
                        if (sessionForm) {
                            sessionForm.style.display = 'none';
                        }
                        
                        // Enable chat input
                        const chatInput = getActiveChatInput();
                        if (chatInput) {
                            chatInput.disabled = false;
                            chatInput.placeholder = 'Type your message...';
                        }
                        
                        // Update session name in header
                        const sessionNameDisplay = document.getElementById('session-name-display');
                        if (sessionNameDisplay) {
                            sessionNameDisplay.textContent = sessionCode;
                        }
                        
                        // Store session code for future Quick Connect use
                        localStorage.setItem('last-session-code', sessionCode);
                        localStorage.setItem('storyteller-name', storytellerName);
                        console.log(` Stored session for Quick Connect: ${sessionCode} (${storytellerName})`);
                        
                    } else {
                        throw new Error(result.error || 'Connection failed');
                    }
                } else {
                    throw new Error('fullSupabaseConnect function not available');
                }
                
            } catch (error) {
                console.error('Session creation error:', error);
                
                // Check if it's a schema-related error and provide helpful message
                if (error.message.includes('is_active') || error.message.includes('schema cache')) {
                    updateConnectionStatus('Database Schema Error', 'error');
                    addChatMessage(` Database schema issue: ${error.message}`, 'system');
                    addChatMessage(` Please check your Supabase database setup - 'is_active' column may be missing`, 'system');
                } else {
                    updateConnectionStatus('Connection Error', 'error');
                    addChatMessage(` Connection error: ${error.message}`, 'system');
                }
                
                addChatMessage(` Starting in local mode...`, 'system');
                
                // Start local session as fallback
                startLocalSession(storytellerName, sessionCode);
            }
        }

        // Helper function for local session start
        function startLocalSession(storytellerName, sessionCode) {
            // Hide session form
            const sessionForm = document.getElementById('session-form');
            if (sessionForm) {
                sessionForm.style.display = 'none';
            }
            
            // Set global variables for compatibility
            window.playerName = storytellerName;
            window.isStoryteller = true;
            window.isStoryTeller = true; // Fix naming inconsistency
            
            // Set connection status to offline
            updateConnectionStatus('Offline', 'offline');
            addChatMessage(` Session "${sessionCode}" started in local mode.`, 'system');
            addChatMessage(` ${storytellerName} is the Storyteller`, 'system');
            addChatMessage(' Player URL updated - check Settings to share', 'system');
            
            // Update player count
            const playerCount = document.getElementById('player-count');
            if (playerCount) {
                playerCount.textContent = '1'; // Storyteller counts as 1
            }
            
            // Update session name display
            const sessionDisplay = document.getElementById('session-name-display');
            if (sessionDisplay) {
                sessionDisplay.textContent = sessionCode;
            }
        }

        // Helper function to update connection status UI
        function updateConnectionStatus(message, type = 'info') {
            const connectionStatus = document.getElementById('connection-status');
            if (connectionStatus) {
                // Update the class to use connection-status with proper type
                connectionStatus.className = `connection-status ${type}`;
                
                // Update the icon based on status
                let icon = 'wifi_off';
                switch (type) {
                    case 'success':
                        icon = 'wifi';
                        break;
                    case 'warning':
                        icon = 'sync';
                        break;
                    case 'error':
                        icon = 'wifi_off';
                        break;
                    case 'offline':
                    default:
                        icon = 'wifi_off';
                        break;
                }
                
                // Update content with icon and message
                connectionStatus.innerHTML = `
                    <i class="material-icons">${icon}</i>
                    ${message}
                `;
            }
            
            console.log(` Connection Status: ${message}`);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.panel-dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(el => {
                    el.classList.remove('show');
                });
            }
        });

        // Window resize handler
        window.addEventListener('resize', function() {
            detectDevice();
        });

        // Load recent chat messages (last minute) when panel loads
        async function loadRecentChatHistory() {
            if (!window.supabase || !window.currentGameSession) {
                console.log('Chat history: Not connected to session');
                return;
            }

            try {
                const oneMinuteAgo = new Date(Date.now() - 60000).toISOString();
                
                const { data: messages, error } = await window.supabase
                    .from('game_messages')
                    .select('*')
                    .eq('session_code', window.currentGameSession.session_code)
                    .gte('created_at', oneMinuteAgo)
                    .order('created_at', { ascending: true });
                    
                if (error) throw error;
                
                // Clear existing messages and display recent ones
                const chatMessages = getActiveChatMessages();
                if (chatMessages && messages.length > 0) {
                    chatMessages.innerHTML = '';
                    messages.forEach(message => {
                        if (window.displayChatMessage) {
                            window.displayChatMessage(message);
                        }
                    });
                    console.log(` Loaded ${messages.length} recent messages`);
                    
                    // Reset chat container after loading messages
                    setTimeout(() => {
                        resetChatContainer();
                    }, 100);
                }
                
            } catch (error) {
                console.warn(' Failed to load chat history:', error.message);
            }
        }

        // Make function globally available
        window.loadRecentChatHistory = loadRecentChatHistory;

        // Admin Panel Functions
        function exportAllData() {
            alert('Export Data: This feature will export all session data to a JSON file.');
            // TODO: Implement data export functionality
        }

        function showBackupStatus() {
            alert('Backup Status: Checking backup status...');
            // TODO: Implement backup status check
        }

        function resetSession() {
            if (confirm('Are you sure you want to reset the current session? This will clear all data!')) {
                alert('Reset Session: This feature will reset the current session.');
                // TODO: Implement session reset functionality
            }
        }

        // Storage Management Functions
        async function showStorageStats() {
            try {
                let stats;
                if (window.advancedStorageManager) {
                    stats = await window.advancedStorageManager.getStorageStats();
                } else {
                    // Fallback for basic localStorage stats
                    let used = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            used += localStorage[key].length + key.length;
                        }
                    }
                    stats = {
                        localStorage: {
                            used: used,
                            usedMB: (used / (1024 * 1024)).toFixed(2),
                            percentage: Math.round((used / (5 * 1024 * 1024)) * 100)
                        }
                    };
                }

                const message = ` Storage Usage:
localStorage: ${stats.localStorage.usedMB}MB (${stats.localStorage.percentage}%)
${stats.indexedDB?.supported ? ' IndexedDB available' : ' IndexedDB not available'}
${stats.cordova?.detected ? ' Cordova app detected' : ' Web browser mode'}`;

                addChatMessage(message, 'system');
            } catch (error) {
                console.error('Storage stats error:', error);
                addChatMessage(' Failed to get storage statistics', 'system');
            }
        }

        async function migrateToIndexedDB() {
            try {
                if (!window.advancedStorageManager) {
                    addChatMessage(' Advanced storage manager not available', 'system');
                    return;
                }

                if (!window.storageMigration) {
                    addChatMessage(' Storage migration not available', 'system');
                    return;
                }

                addChatMessage(' Starting migration to IndexedDB...', 'system');
                await window.storageMigration.runMigration();
                addChatMessage(' Migration completed successfully!', 'system');
            } catch (error) {
                console.error('Migration error:', error);
                addChatMessage(' Migration failed: ' + error.message, 'system');
            }
        }
    </script>

    <!-- Hidden compatibility elements for legacy modules -->
    <div style="display: none;">
        <!-- Tab Navigation Compatibility -->
        <nav class="tab-nav" id="tabNav">
            <div class="tab-container">
                <!-- Content containers that modules expect -->
                <div id="saved-npcs-grid"></div>
                <div id="saved-loot-container"></div>
                <div id="saved-maps-container"></div>
                <div id="map-grid"></div>
                
                <!-- Form elements that modules expect -->
                <select id="npc-filter"></select>
                <select id="loot-filter"></select>
                <select id="loot-type-select"></select>
                <select id="map-size-select"></select>
                <div id="special-items-group"></div>
                
                <!-- Display elements that modules expect -->
                <div id="grid-size-display"></div>
                <div id="tiles-placed"></div>
            </div>
        </nav>
        
        <!-- Session Management -->
        <div id="session-modal" style="display: none;">
            <input type="file" id="import-file" accept=".json">
            <input id="session-name-input">
            <div id="sessions-list"></div>
        </div>
        
        <!-- Map Editor Modal -->
        <div id="map-editor-modal" class="map-editor-modal" style="display: none;" onclick="closeMapModal(event)">
            <div class="modal-content map-editor-modal-content" onclick="event.stopPropagation()">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h2> Map Editor</h2>
                    <div class="modal-header-controls">
                        <div id="modal-sprite-status" class="sprite-status-indicator"></div>
                        <button id="close-map-modal" class="btn-close"></button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="modal-body">
                    <!-- Map Controls -->
                    <div class="map-controls-section">
                        <div class="control-group">
                            <label>Map Size:</label>
                            <div class="size-buttons">
                                <button class="size-btn" data-size="small" onclick="setMapSize('small')">1010</button>
                                <button class="size-btn active" data-size="medium" onclick="setMapSize('medium')">1515</button>
                                <button class="size-btn" data-size="large" onclick="setMapSize('large')">2020</button>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <button onclick="clearMap()" class="btn warning"> Clear Map</button>
                        </div>
                    </div>
                    
                    <!-- Tile Selector -->
                    <div class="tile-selector-section">
                        <h4>Select Tile:</h4>
                        <div id="modal-tile-selector" class="tile-selector-grid"></div>
                    </div>
                    
                    <!-- Map Grid -->
                    <div class="map-grid-section">
                        <div id="modal-map-grid" class="map-grid"></div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <div class="map-name-section">
                        <input type="text" id="modal-map-name" placeholder="Enter map name..." value="Untitled Map">
                    </div>
                    <div class="modal-actions">
                        <button onclick="saveMapAsFile()" class="btn success"> Save Map</button>
                        <button onclick="closeMapModal()" class="btn secondary"> Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Editor Elements -->
        <!-- Tile selector now integrated into map panel -->
    </div>
    
    <!-- Avatar and Image Systems -->
    <script src="js/avatarAssignmentSystem.js"></script>
    <script src="js/chatImageUploadIntegration.js"></script>
</body>
</html>
